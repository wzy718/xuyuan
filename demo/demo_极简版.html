<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ‹œæ‹œ Demoï¼ˆæç®€ç‰ˆï¼‰</title>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fafafa; --card:#fff; --bd:#e6e6e6; --good:#0a7a2a; --bad:#b00020; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif; color:var(--fg); background:var(--bg); }
    header{ padding:16px; border-bottom:1px solid var(--bd); background:#fff; position:sticky; top:0; z-index:10; }
    header h1{ margin:0; font-size:18px; }
    header p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.4; }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; display:grid; gap:14px; grid-template-columns: 1fr; }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
    h2{ margin:0 0 10px; font-size:16px; }
    label{ display:block; margin:10px 0 6px; font-size:13px; color:var(--muted); }
    textarea, input, select{ width:100%; border:1px solid var(--bd); border-radius:12px; padding:10px; font-size:14px; background:#fff; }
    textarea{ min-height:120px; resize:vertical; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{ border:1px solid var(--bd); background:#111; color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px; }
    button.secondary{ background:#fff; color:#111; }
    button.ghost{ background:transparent; color:#111; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; color:var(--muted); background:#fff; }
    .grid{ display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 860px){ .wrap{ grid-template-columns: 1.05fr .95fr; } }
    @media (min-width: 560px){ .grid.two{ grid-template-columns: 1fr 1fr; } }
    ul, ol{ margin:8px 0 0; padding-left:18px; }
    .muted{ color:var(--muted); }
    .locked{ position:relative; border:1px dashed var(--bd); border-radius:12px; padding:10px; background:#fcfcfc; }
    .locked .blur{ filter: blur(4px); user-select:none; pointer-events:none; }
    .lockOverlay{
      position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center;
      gap:10px; padding:14px; text-align:center;
      background:rgba(255,255,255,.72); border-radius:12px;
    }
    .lockOverlay b{ font-size:14px; }
    .fine{ font-size:12px; color:var(--muted); line-height:1.4; }
    .todoRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--bd); border-radius:12px; background:#fff; }
    .todoLeft{ display:flex; gap:10px; align-items:flex-start; }
    .todoTitle{ font-size:14px; line-height:1.3; }
    .tag{ display:inline-block; margin-top:6px; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--bd); color:var(--muted); }
    .tag.good{ color:var(--good); border-color:rgba(10,122,42,.25); }
    .tag.bad{ color:var(--bad); border-color:rgba(176,0,32,.25); }
    .floatingPlus{
      position:fixed; right:16px; bottom:16px; width:54px; height:54px; border-radius:999px;
      border:1px solid var(--bd); background:#111; color:#fff; font-size:28px; line-height:0;
      box-shadow:0 8px 24px rgba(0,0,0,.12); cursor:pointer;
    }

    /* Modal */
    .modalBackdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:50; }
    .modal{ width:min(720px, 100%); background:#fff; border:1px solid var(--bd); border-radius:16px; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,.18); }
    .modalHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
    .modalHeader h3{ margin:0; font-size:16px; }
    .x{ border:1px solid var(--bd); background:#fff; color:#111; border-radius:10px; padding:6px 10px; cursor:pointer; }
    .divider{ height:1px; background:var(--bd); margin:10px 0; }
    .notice{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.4; }
    .mono{ white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px; }
  </style>
</head>
<body>
  <header>
    <h1>æ‹œæ‹œ Demoï¼ˆæç®€ç‰ˆï¼‰</h1>
    <p>ä¸»å±åªæœ‰ä¸€å¥ï¼š<b>æœ€è¿‘è®¸è¿‡ä»€ä¹ˆæ„¿ï¼Ÿå¦‚æœæ²¡æˆåŠŸæˆ‘æ¥åˆ†æåŸå› ï¼</b>ï¼ˆæœ¬é¡µä¸ºå‰ç«¯æ¨¡æ‹Ÿï¼›â€œçœ‹å¹¿å‘Š/åˆ†äº«â€åªåšæ¼”ç¤ºè§£é”ã€‚ï¼‰</p>
  </header>

  <main class="wrap">
    <!-- Left: main input + result -->
    <section class="card">
      <h2>æœ€è¿‘è®¸è¿‡ä»€ä¹ˆæ„¿ï¼Ÿå¦‚æœæ²¡æˆåŠŸæˆ‘æ¥åˆ†æåŸå› ï¼ <span class="pill" id="status">æœªè§£é”æ­£ç¡®å§¿åŠ¿</span></h2>

      <label>è¯·è¾“å…¥ä½ æœ€è¿‘è®¸è¿‡ä½†æ²¡æˆåŠŸçš„æ„¿æœ›ï¼ˆæˆ–ä½ è§‰å¾—å¡ä½çš„æ„¿æœ›ï¼‰</label>
      <textarea id="wishInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³å‘è´¢ã€æˆ‘æƒ³ä¸€åˆ‡é¡ºåˆ©ã€æˆ‘æƒ³ä»–å›æ¥æ‰¾æˆ‘â€¦â€¦"></textarea>

      <div class="btns">
        <button id="analyzeBtn">å¼€å§‹åˆ†æ</button>
        <button id="copyBtn" class="secondary" disabled>å¤åˆ¶æ­£ç¡®å§¿åŠ¿</button>
        <button id="resetBtn" class="secondary">æ¸…ç©º</button>
      </div>

      <div class="divider"></div>

      <div class="grid two">
        <div>
          <h2 style="margin-top:0;">ç¼ºå¤±è¦ç´ </h2>
          <ul id="missingList"></ul>
        </div>
        <div>
          <h2 style="margin-top:0;">æ½œåœ¨åŸå› </h2>
          <ul id="reasonList"></ul>
        </div>
      </div>

      <div class="divider"></div>

      <h2 style="margin-top:0;">æ­£ç¡®å§¿åŠ¿ï¼ˆè§£é”åå¯è§ï¼‰</h2>
      <div class="locked" id="lockedBox">
        <div class="blur" id="lockedContent">
          <div class="mono" id="optimizedText">ï¼ˆè¿™é‡Œä¼šæ˜¾ç¤ºä¼˜åŒ–åçš„è®¸æ„¿ç¨¿ï¼‰</div>
          <div class="divider"></div>
          <b>å»ºè®®è¡¥é½å­—æ®µï¼ˆç¤ºä¾‹ï¼‰</b>
          <ul id="structuredSuggest"></ul>
          <div class="divider"></div>
          <b>å»ºè®®æ­¥éª¤</b>
          <ol id="stepList"></ol>
          <p class="notice">å…è´£å£°æ˜ï¼šæœ¬å·¥å…·ä»…æä¾›è¡¨è¾¾ä¸æµç¨‹å»ºè®®ï¼Œä¸ä¿è¯ä»»ä½•ç»“æœï¼›è¯·ä¿æŒç†æ€§ã€åˆæ³•åˆè§„ã€‚</p>
        </div>

        <div class="lockOverlay" id="lockOverlay">
          <b>è¦çœ‹ã€Œæ­£ç¡®å§¿åŠ¿ã€å—ï¼Ÿ</b>
          <div class="btns" style="justify-content:center;">
            <button id="unlockAdBtn">çœ‹å¹¿å‘Šè§£é”</button>
            <button id="unlockShareBtn" class="secondary">åˆ†äº«è§£é”</button>
          </div>
          <div class="fine">æ¼”ç¤ºç‰ˆï¼šç‚¹å‡»å³è§£é”ï¼ˆçº¿ä¸Šç‰ˆéœ€æ¥å…¥æ¿€åŠ±è§†é¢‘/åˆ†äº«å›è°ƒï¼‰ã€‚</div>
        </div>
      </div>

    </section>

    <!-- Right: TODO list -->
    <aside class="card">
      <h2>æˆ‘çš„æ„¿æœ›ï¼ˆTODOï¼‰</h2>
      <p class="muted" style="margin-top:6px;">æŠŠæ„¿æœ›è®°ä¸‹æ¥ï¼ŒæˆåŠŸå°±å‹¾é€‰ã€‚å‹¾é€‰æˆåŠŸåä¼šå¼¹ 1 å…ƒä»£è®¸æ„¿æç¤ºï¼ˆæ¼”ç¤ºï¼‰ã€‚</p>
      <div id="todoList"></div>
      <p class="notice">æç¤ºï¼šDemo ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼ˆlocalStorageï¼‰ã€‚</p>
    </aside>
  </main>

  <button class="floatingPlus" id="plusBtn" title="å†è®¸ä¸€ä¸ªæ„¿">+</button>

  <!-- Add Wish Modal -->
  <div class="modalBackdrop" id="addModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>å†è®¸ä¸€ä¸ªæ„¿ï¼ˆç»“æ„åŒ–è®°å½•ï¼‰</h3>
        <button class="x" id="closeAdd">å…³é—­</button>
      </div>

      <div class="grid two">
        <div>
          <label>å¯¹è±¡ï¼ˆå¿…å¡«ï¼‰</label>
          <select id="mDeity">
            <option value="è§‚éŸ³è©è¨">è§‚éŸ³è©è¨</option>
            <option value="é˜¿å¼¥é™€ä½›">é˜¿å¼¥é™€ä½›</option>
            <option value="æ–‡æ®Šè©è¨">æ–‡æ®Šè©è¨</option>
            <option value="åœ°è—è©è¨">åœ°è—è©è¨</option>
            <option value="å¤ªå²">å¤ªå²</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        <div>
          <label>æ—¶é—´èŒƒå›´ï¼ˆå»ºè®®ï¼‰</label>
          <input id="mTime" placeholder="ä¾‹å¦‚ï¼š3 ä¸ªæœˆå†… / 2026 å¹´å†…" />
        </div>
      </div>

      <label>æ„¿æœ›åŸæ–‡ï¼ˆå¿…å¡«ï¼‰</label>
      <textarea id="mWish" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ› 3 ä¸ªæœˆå†…æ‰¾åˆ°æ›´åˆé€‚çš„å·¥ä½œï¼Œè–ªèµ„è¾¾åˆ°â€¦â€¦"></textarea>

      <div class="grid two">
        <div>
          <label>ç›®æ ‡é‡åŒ–ï¼ˆå»ºè®®ï¼‰</label>
          <input id="mMetric" placeholder="ä¾‹å¦‚ï¼šç¨åæœˆæ”¶å…¥â‰¥X / æˆç»©â‰¥X" />
        </div>
        <div>
          <label>æ–¹å¼è¾¹ç•Œï¼ˆå»ºè®®ï¼‰</label>
          <input id="mBoundary" placeholder="ä¾‹å¦‚ï¼šåˆæ³•åˆè§„ã€ä¸ä¼¤å®³ä»–äººã€ä¸ä»¥ç¾ç¥¸æ¢é’±" />
        </div>
      </div>

      <div class="grid two">
        <div>
          <label>è¡ŒåŠ¨æ‰¿è¯ºï¼ˆå»ºè®®ï¼‰</label>
          <input id="mAction" placeholder="ä¾‹å¦‚ï¼šæ¯å¤©å­¦ä¹  2 å°æ—¶ã€æ¯å‘¨æŠ•é€’ 10 ä»½ç®€å†" />
        </div>
        <div>
          <label>è¿˜æ„¿/å›å‘ï¼ˆå¯é€‰ï¼‰</label>
          <input id="mVow" placeholder="ä¾‹å¦‚ï¼šå¸ƒæ–½ã€ä¾›ç¯ã€å¸®åŠ©å®¶äººã€æèµ " />
        </div>
      </div>

      <div class="btns">
        <button id="saveWishBtn">ç¡®è®¤è®°å½•</button>
        <button id="aiOptimizeBtn" class="secondary">ä¸€é”® AI ä¼˜åŒ–ï¼ˆéœ€è§£é”ï¼‰</button>
      </div>

      <p class="notice">è¯´æ˜ï¼šçœŸå®å°ç¨‹åºä¸­ï¼Œâ€œAI ä¼˜åŒ–â€å°†æŠŠä¸Šè¿°å­—æ®µä¸åŸæ–‡ä¸€èµ·å‘ç»™åç«¯æ¨¡å‹è¾“å‡ºã€‚</p>
    </div>
  </div>

  <!-- Success upsell modal -->
  <div class="modalBackdrop" id="payModal">
    <div class="modal">
      <div class="modalHeader">
        <h3>å·²æˆåŠŸ ğŸ‰</h3>
        <button class="x" id="closePay">å…³é—­</button>
      </div>
      <p style="margin:6px 0 0;">æ­å–œï¼è¦ä¸è¦ä»˜ <b>1 å…ƒ</b>è®©åˆ«äººæ›¿ä½ è®¸æ„¿/è¿˜æ„¿å›å‘ï¼Ÿ</p>

      <div class="divider"></div>

      <label>å¯¹è±¡</label>
      <input id="pDeity" />

      <label>è®¸æ„¿ç¨¿ï¼ˆå¯ç¼–è¾‘ï¼‰</label>
      <textarea id="pText" class="mono"></textarea>

      <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
      <input id="pNote" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›åœ¨æŸä¸ªæ—¶é—´æ®µã€æŸä¸ªåœ°ç‚¹ä»£è®¸æ„¿" />

      <div class="btns">
        <button id="payBtn">1 å…ƒä»£è®¸æ„¿ï¼ˆæ¼”ç¤ºæ”¯ä»˜ï¼‰</button>
        <button id="noPayBtn" class="secondary">æš‚ä¸éœ€è¦</button>
      </div>

      <p class="notice">å…è´£å£°æ˜ï¼šä»£è®¸æ„¿ä¸ºæœåŠ¡è¡Œä¸ºï¼Œæä¾›è¿‡ç¨‹è®°å½•ï¼Œä¸æ‰¿è¯ºç»“æœã€‚</p>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "baibai_todo_v1";
  const UNLOCK_KEY = "baibai_unlocked_v1";

  let unlocked = localStorage.getItem(UNLOCK_KEY) === "1";

  function setUnlocked(v){
    unlocked = v;
    localStorage.setItem(UNLOCK_KEY, v ? "1" : "0");
    $("lockOverlay").style.display = unlocked ? "none" : "flex";
    $("status").textContent = unlocked ? "å·²è§£é”æ­£ç¡®å§¿åŠ¿" : "æœªè§£é”æ­£ç¡®å§¿åŠ¿";
    $("copyBtn").disabled = !unlocked || !$("optimizedText").textContent || $("optimizedText").textContent.includes("ï¼ˆè¿™é‡Œä¼šæ˜¾ç¤º");
  }

  function loadTodo(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }catch(e){
      return [];
    }
  }

  function saveTodo(list){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  function shortText(s, n=26){
    s = (s || "").trim().replace(/\s+/g, " ");
    return s.length > n ? s.slice(0, n) + "â€¦" : s;
  }

  function safeFallback(v, fallback){
    v = (v || "").trim();
    return v ? v : fallback;
  }

  // ---- Simulated AI logic (demo only) ----
  function analyzeText(wish){
    const missing = [];
    const reasons = [];

    const hasTime = /(\d+\s*(å¤©|å‘¨|æ˜ŸæœŸ|æœˆ|ä¸ªæœˆ|å¹´)|ä»Šå¹´|æ˜å¹´|æœ¬æœˆ|ä¸‹æœˆ|è¿‘æœŸ|ä¸‰ä¸ªæœˆå†…|åŠå¹´å†…)/.test(wish);
    const hasMetric = /(\d+\s*(å…ƒ|ä¸‡|w|k|åˆ†|åˆ†æ•°|åæ¬¡|offer|å®¶|å•|å€|%))/i.test(wish);
    const hasBoundary = /(åˆæ³•|åˆè§„|ä¸ä¼¤å®³|ä¸å®³äºº|ä¸è¿èƒŒè‰¯å¿ƒ|ä¸ä»¥ç¾ç¥¸|ä¸èµ°åé—¨)/.test(wish);
    const hasAction = /(æˆ‘ä¼š|æˆ‘æ„¿æ„|æ¯å¤©|æ¯å‘¨|åšæŒ|åŠªåŠ›|å­¦ä¹ |æŠ•é€’|é”»ç‚¼|æ²Ÿé€š|æ”¹è¿›)/.test(wish);
    const hasVow = /(è¿˜æ„¿|å›å‘|å¸ƒæ–½|æ|ä¾›ç¯|è¡Œå–„|éšå–œ)/.test(wish);

    if(!hasTime) missing.push("æ—¶é—´è¾¹ç•Œï¼ˆä¾‹å¦‚ï¼š3 ä¸ªæœˆå†… / 2026 å¹´å†…ï¼‰");
    if(!hasMetric) missing.push("å¯éªŒè¯çš„é‡åŒ–ç›®æ ‡ï¼ˆé‡‘é¢/å­˜æ¬¾/æˆç»©/offer ç­‰ï¼‰");
    if(!hasBoundary) missing.push("æ–¹å¼ä¸è¾¹ç•Œï¼ˆåˆæ³•åˆè§„ã€ä¸ä¼¤å®³ä»–äººã€ä¸ä»¥ç¾ç¥¸æ¢é’±ï¼‰");
    if(!hasAction) missing.push("è¡ŒåŠ¨æ‰¿è¯ºï¼ˆä½ å‡†å¤‡åšä»€ä¹ˆï¼‰");
    if(!hasVow) missing.push("è¿˜æ„¿/å›å‘ï¼ˆå¯é€‰ï¼Œä½†æœ‰åŠ©äºå½¢æˆé—­ç¯ï¼‰");

    if(wish.length < 12) reasons.push("æ„¿æœ›è¿‡çŸ­ä¸”æŠ½è±¡ï¼Œä¿¡æ¯ä¸è¶³ï¼Œå®¹æ˜“å˜æˆâ€œæ³›æ³›çš„æƒ³è¦â€ã€‚");
    if(!hasMetric) reasons.push("ç›®æ ‡ä¸å¯éªŒè¯ï¼šä½ æ— æ³•åˆ¤æ–­â€œç®—ä¸ç®—è¾¾æˆâ€ï¼Œä¹Ÿä¸åˆ©äºè‡ªå·±è¡ŒåŠ¨ã€‚");
    if(!hasTime) reasons.push("ç¼ºå°‘æˆªæ­¢æ—¶é—´ï¼šæ²¡æœ‰æœŸé™å°±å¾ˆéš¾å½¢æˆæ¨è¿›æ„Ÿä¸åé¦ˆã€‚");
    if(!hasBoundary) reasons.push("æœªå£°æ˜è¾¹ç•Œï¼šå®¹æ˜“å‡ºç°â€œæ–¹å¼ä¸å—æ§â€çš„è¡¨è¾¾é£é™©ï¼ˆå»ºè®®åŠ ä¸Šæ­£å½“ã€å–„æ„ä¸ä¸ä¼¤å®³ï¼‰ã€‚");
    if(/å¿…é¡»|ä¸€å®šè¦|éä»–ä¸å¯|ç«‹åˆ»/.test(wish)) reasons.push("è¡¨è¾¾å¯èƒ½è¿‡åº¦æ‰§å¿µï¼šå»ºè®®è½¬ä¸ºâ€œæ”¹å–„æ²Ÿé€š/æå‡è‡ªå·±/é‡åˆ°æ›´åˆé€‚çš„ç¼˜åˆ†â€ã€‚");

    const risky = ["èµŒåš","éª—","æŠ¥å¤","å®³","è¯…å’’","æ€","å¼„æ­»"];
    if(risky.some(w => wish.includes(w))){
      reasons.push("æ£€æµ‹åˆ°å¯èƒ½çš„è¿æ³•/ä¼¤å®³å€¾å‘ï¼šå»ºè®®è°ƒæ•´ä¸ºå–„æ„ã€åˆæ³•åˆè§„çš„è¡¨è¾¾ã€‚");
    }

    if(missing.length === 0) missing.push("åŸºæœ¬è¦ç´ é½å…¨ï¼ˆå¯è¿›ä¸€æ­¥æ¶¦è‰²è¡¨è¾¾ä¸æ­¥éª¤ï¼‰ã€‚");
    if(reasons.length === 0) reasons.push("ä»è¡¨è¾¾å±‚é¢çœ‹è¾ƒæ¸…æ™°ï¼Œå»ºè®®ä¿æŒè¡ŒåŠ¨æ‰¿è¯ºå¹¶å®šæœŸå¤ç›˜ã€‚");

    return { missing, reasons };
  }

  function buildLockedPack(rawWish, deity="ï¼ˆå¯¹è±¡å¯é€‰ï¼‰"){
    const time = "ï¼ˆè¡¥å……æœŸé™ï¼‰";
    const metric = "ï¼ˆè¡¥å……é‡åŒ–ç›®æ ‡ï¼‰";
    const boundary = "åˆæ³•åˆè§„ã€ä¸ä¼¤å®³ä»–äººã€ä¸è¿èƒŒè‰¯å¿ƒã€ä¸ä»¥ç¾ç¥¸ä¸ä¼¤å®³äº¤æ¢æ‰€å¾—";
    const action = "æˆ‘æ„¿æ„æŒç»­åŠªåŠ›ä¸ä¿®æ­£ï¼ˆè¡¥å……å…·ä½“è¡ŒåŠ¨ï¼Œå¦‚æ¯å¤©å­¦ä¹ /æ¯å‘¨æŠ•é€’/æ¯æœˆå‚¨è“„ç­‰ï¼‰";
    const vow = "è‹¥å› ç¼˜å…·è¶³ï¼Œæˆ‘å°†éšåŠ›è¡Œå–„å›å‘å¹¶æ„Ÿæ©ã€‚";

    const optimized = `å¼Ÿå­/ä¿¡ä¼—è‡³å¿ƒç¤¼æ•¬ ${deity}ã€‚\n\næˆ‘æ‰€æ±‚ä¹‹äº‹ä¸ºï¼š${rawWish.trim()}ã€‚\n\næ„¿ä»¥ã€Œ${time}ã€ä¸ºæœŸï¼Œç›®æ ‡æ¸…æ™°å¯éªŒï¼š${metric}ã€‚\næˆ‘ç¥ˆæ±‚ä»¥æ­£å½“æ–¹å¼æˆå°±ï¼š${boundary}ã€‚\n\næˆ‘äº¦å‘æ„¿ï¼š${action}ã€‚\n${vow}\n\nç¥ˆæ„¿è¯¸äº‹éšç¼˜å¾—æˆï¼Œè‹¥æœªå¾—æˆäº¦æ„¿å¢é•¿æ™ºæ…§ä¸å¹³å®‰ï¼Œæ„Ÿæ©ã€‚`;

    const structured = [
      "å¯¹è±¡ï¼šä½ æƒ³æ‹œçš„ä½›/è©è¨/å¤ªå²ï¼ˆæ˜ç¡®åç§°ï¼‰",
      "æ—¶é—´ï¼šä¾‹å¦‚ 3 ä¸ªæœˆå†… / 2026 å¹´å†…",
      "é‡åŒ–ï¼šä¾‹å¦‚ ç¨åæœˆæ”¶å…¥â‰¥Xã€å­˜æ¬¾â‰¥Xã€æˆç»©â‰¥Xã€æ‹¿åˆ°offerç­‰",
      "è¾¹ç•Œï¼šåˆæ³•åˆè§„ã€ä¸ä¼¤å®³ä»–äººã€ä¸èµ°åé—¨ã€ä¸ä»¥ç¾ç¥¸æ¢å–",
      "è¡ŒåŠ¨ï¼šä¾‹å¦‚ æ¯å¤©å­¦ä¹  2 å°æ—¶ / æ¯å‘¨æŠ•é€’ 10 ä»½ç®€å† / æ¯æœˆå‚¨è“„ 20%",
      "è¿˜æ„¿ï¼šä¾‹å¦‚ å¸ƒæ–½/ä¾›ç¯/å¸®åŠ©å®¶äºº/æèµ ï¼ˆé‡åŠ›è€Œè¡Œï¼‰"
    ];

    const steps = [
      "å‡€æ‰‹é™å¿ƒï¼Œæ‰‹æœºé™éŸ³ï¼ŒåˆæŒç‰‡åˆ»ã€‚",
      "ç§°å¿µåå·/åœ£å· 3 æ¬¡ï¼ˆéšå½“åœ°ä¹ ä¿—ï¼‰ã€‚",
      "è¯´æ˜â€œæˆ‘æ˜¯è°â€ï¼ˆç§°å‘¼/åŸå¸‚ç­‰å¯é€‰ï¼‰ï¼Œè¯´æ˜æ¥æ„ã€‚",
      "æœ—è¯»ä¼˜åŒ–åçš„è®¸æ„¿ç¨¿ï¼ˆæ—¶é—´ã€é‡åŒ–ã€è¾¹ç•Œã€è¡ŒåŠ¨æ˜¯é‡ç‚¹ï¼‰ã€‚",
      "è‡´è°¢å›å‘ï¼šæ„¿å°†æ‰€ä¿®å–„è¡Œå›å‘å®¶äºº/ä¼—ç”Ÿï¼ˆå¯é€‰ï¼‰ã€‚",
      "ç¦»å¼€æ—¶ä¿æŒå¹³å’Œï¼Œä¸å–§å“—ï¼Œä¹‹åæŒ‰è¡ŒåŠ¨æ‰¿è¯ºå»åšã€‚"
    ];

    return { optimized, structured, steps };
  }

  function renderAnalysis(raw){
    const a = analyzeText(raw);
    $("missingList").innerHTML = a.missing.map(x => `<li>${x}</li>`).join("");
    $("reasonList").innerHTML = a.reasons.map(x => `<li>${x}</li>`).join("");

    const pack = buildLockedPack(raw, "ï¼ˆä½ é€‰æ‹©çš„å¯¹è±¡ï¼‰");
    $("optimizedText").textContent = pack.optimized;
    $("structuredSuggest").innerHTML = pack.structured.map(x => `<li>${x}</li>`).join("");
    $("stepList").innerHTML = pack.steps.map(x => `<li>${x}</li>`).join("");

    $("copyBtn").disabled = !unlocked;
  }

  function renderTodo(){
    const list = loadTodo();
    const container = $("todoList");
    if(list.length === 0){
      container.innerHTML = `<p class="muted" style="margin:8px 0 0;">è¿˜æ²¡æœ‰è®°å½•ã€‚ç‚¹å³ä¸‹è§’ â€œ+â€ å†è®¸ä¸€ä¸ªæ„¿ã€‚</p>`;
      return;
    }

    container.innerHTML = list.map(item => {
      const statusTag = item.done
        ? `<span class="tag good">å·²æˆåŠŸ</span>`
        : `<span class="tag bad">æœªæˆåŠŸ</span>`;

      const deity = item.deity ? ` Â· ${item.deity}` : "";
      const sub = item.time || item.metric ? `<div class="muted" style="margin-top:4px; font-size:12px;">${[item.time, item.metric].filter(Boolean).join(" Â· ")}</div>` : "";

      return `
        <div class="todoRow" data-id="${item.id}">
          <div class="todoLeft">
            <input type="checkbox" ${item.done ? "checked" : ""} aria-label="mark done" class="todoCheck" />
            <div>
              <div class="todoTitle">${shortText(item.wish)}${deity}</div>
              ${statusTag}
              ${sub}
            </div>
          </div>
          <button class="ghost todoDetailBtn" title="æŸ¥çœ‹/å¤åˆ¶">æŸ¥çœ‹</button>
        </div>
      `;
    }).join("");

    container.querySelectorAll(".todoCheck").forEach(chk => {
      chk.addEventListener("change", (e) => {
        const id = e.target.closest(".todoRow").dataset.id;
        const list = loadTodo();
        const it = list.find(x => x.id === id);
        if(!it) return;
        it.done = e.target.checked;
        saveTodo(list);
        renderTodo();

        if(it.done){
          openPayModal(it);
        }
      });
    });

    container.querySelectorAll(".todoDetailBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const row = btn.closest(".todoRow");
        const id = row.dataset.id;
        const list = loadTodo();
        const it = list.find(x => x.id === id);
        if(!it) return;

        $("wishInput").value = it.wish;
        renderAnalysis(it.wish);

        if(unlocked){
          const pack = buildLockedPack(it.wish, it.deity || "ï¼ˆå¯¹è±¡ï¼‰");
          $("optimizedText").textContent = pack.optimized;
          $("structuredSuggest").innerHTML = pack.structured.map(x => `<li>${x}</li>`).join("");
          $("stepList").innerHTML = pack.steps.map(x => `<li>${x}</li>`).join("");
        }

        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
  }

  function openAddModal(){ $("addModal").style.display = "flex"; }
  function closeAddModal(){ $("addModal").style.display = "none"; }

  function openPayModal(todoItem){
    $("payModal").style.display = "flex";
    $("pDeity").value = todoItem.deity || "";
    const pack = buildLockedPack(todoItem.wish, todoItem.deity || "ï¼ˆå¯¹è±¡ï¼‰");
    $("pText").value = pack.optimized;
    $("pNote").value = "";
  }
  function closePayModal(){ $("payModal").style.display = "none"; }

  function simulateUnlock(kind){
    const btn = kind === "ad" ? $("unlockAdBtn") : $("unlockShareBtn");
    const old = btn.textContent;
    btn.disabled = true;
    let n = 3;
    btn.textContent = kind === "ad" ? `æ¨¡æ‹Ÿçœ‹å¹¿å‘Šâ€¦ ${n}` : `æ¨¡æ‹Ÿåˆ†äº«â€¦ ${n}`;
    const t = setInterval(() => {
      n -= 1;
      if(n <= 0){
        clearInterval(t);
        btn.textContent = old;
        btn.disabled = false;
        setUnlocked(true);
      }else{
        btn.textContent = kind === "ad" ? `æ¨¡æ‹Ÿçœ‹å¹¿å‘Šâ€¦ ${n}` : `æ¨¡æ‹Ÿåˆ†äº«â€¦ ${n}`;
      }
    }, 550);
  }

  $("analyzeBtn").addEventListener("click", () => {
    const raw = $("wishInput").value.trim();
    if(!raw){ alert("å…ˆå†™ä¸€å¥ä½ æœ€è¿‘è®¸è¿‡çš„æ„¿æœ›å§ã€‚"); return; }
    renderAnalysis(raw);
  });

  $("resetBtn").addEventListener("click", () => {
    $("wishInput").value = "";
    $("missingList").innerHTML = "";
    $("reasonList").innerHTML = "";
    $("optimizedText").textContent = "ï¼ˆè¿™é‡Œä¼šæ˜¾ç¤ºä¼˜åŒ–åçš„è®¸æ„¿ç¨¿ï¼‰";
    $("structuredSuggest").innerHTML = "";
    $("stepList").innerHTML = "";
    $("copyBtn").disabled = true;
  });

  $("copyBtn").addEventListener("click", async () => {
    if(!unlocked){ alert("éœ€è¦å…ˆè§£é”â€œæ­£ç¡®å§¿åŠ¿â€ã€‚"); return; }
    try{
      await navigator.clipboard.writeText($("optimizedText").textContent);
      $("status").textContent = "å·²å¤åˆ¶æ­£ç¡®å§¿åŠ¿";
      setTimeout(() => $("status").textContent = unlocked ? "å·²è§£é”æ­£ç¡®å§¿åŠ¿" : "æœªè§£é”æ­£ç¡®å§¿åŠ¿", 1200);
    }catch(e){
      alert("å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶ã€‚");
    }
  });

  $("unlockAdBtn").addEventListener("click", () => simulateUnlock("ad"));
  $("unlockShareBtn").addEventListener("click", () => simulateUnlock("share"));

  $("plusBtn").addEventListener("click", openAddModal);
  $("closeAdd").addEventListener("click", closeAddModal);
  $("addModal").addEventListener("click", (e) => { if(e.target === $("addModal")) closeAddModal(); });

  $("saveWishBtn").addEventListener("click", () => {
    const deity = $("mDeity").value;
    const wish = $("mWish").value.trim();
    if(!deity.trim() || !wish){ alert("å¯¹è±¡å’Œæ„¿æœ›åŸæ–‡ä¸ºå¿…å¡«ã€‚"); return; }

    const list = loadTodo();
    list.unshift({
      id: String(Date.now()),
      deity,
      wish,
      time: $("mTime").value.trim(),
      metric: $("mMetric").value.trim(),
      boundary: $("mBoundary").value.trim(),
      action: $("mAction").value.trim(),
      vow: $("mVow").value.trim(),
      done: false
    });
    saveTodo(list);
    renderTodo();

    ["mWish","mTime","mMetric","mBoundary","mAction","mVow"].forEach(id => $(id).value = "");
    $("mDeity").value = "è§‚éŸ³è©è¨";
    closeAddModal();
  });

  $("aiOptimizeBtn").addEventListener("click", () => {
    if(!unlocked){ alert("ä¸€é”® AI ä¼˜åŒ–éœ€è¦å…ˆè§£é”ï¼šçœ‹å¹¿å‘Š/åˆ†äº«ã€‚"); return; }

    const deity = $("mDeity").value;
    const wish = $("mWish").value.trim();
    const time = $("mTime").value.trim();
    const metric = $("mMetric").value.trim();
    const boundary = $("mBoundary").value.trim();
    const action = $("mAction").value.trim();
    const vow = $("mVow").value.trim();

    if(!wish){ alert("å…ˆå†™æ„¿æœ›åŸæ–‡ï¼Œæˆ‘æ‰èƒ½å¸®ä½ ä¼˜åŒ–ã€‚"); return; }

    const who = "ï¼ˆå¯ç”¨æ˜µç§°/åŸå¸‚å¯é€‰ï¼‰";
    const optimized = `å¼Ÿå­/ä¿¡ä¼— ${who}ï¼Œä»Šæ—¥è‡³å¿ƒç¤¼æ•¬ ${deity}ã€‚\n\næˆ‘æ‰€æ±‚ä¹‹äº‹ä¸ºï¼š${wish}ã€‚\n\næ„¿ä»¥ã€Œ${safeFallback(time, "ï¼ˆè¯·è¡¥å……æ—¶é—´èŒƒå›´ï¼‰")}ã€ä¸ºæœŸï¼Œç›®æ ‡æ¸…æ™°å¯éªŒï¼š${safeFallback(metric, "ï¼ˆè¯·è¡¥å……é‡åŒ–ç›®æ ‡ï¼‰")}ã€‚\næˆ‘ç¥ˆæ±‚ä»¥æ­£å½“æ–¹å¼æˆå°±ï¼š${safeFallback(boundary, "åˆæ³•åˆè§„ã€ä¸ä¼¤å®³ä»–äººã€ä¸ä»¥ç¾ç¥¸æ¢é’±")}ã€‚\n\næˆ‘äº¦å‘æ„¿ï¼š${safeFallback(action, "æˆ‘æ„¿æ„æŒç»­åŠªåŠ›ä¸ä¿®æ­£ï¼ˆè¡¥å……å…·ä½“è¡ŒåŠ¨ï¼‰")}ã€‚\n${vow ? `è‹¥å› ç¼˜å…·è¶³ï¼Œæˆ‘å°†ä»¥ã€Œ${vow}ã€å›å‘å¹¶æ„Ÿæ©ã€‚` : "è‹¥å› ç¼˜å…·è¶³ï¼Œæˆ‘å°†éšåŠ›è¡Œå–„å›å‘å¹¶æ„Ÿæ©ã€‚"}\n\nç¥ˆæ„¿è¯¸äº‹éšç¼˜å¾—æˆï¼Œæ„Ÿæ©ã€‚`;

    $("wishInput").value = wish;
    renderAnalysis(wish);
    $("optimizedText").textContent = optimized;
    $("status").textContent = "å·²è§£é”æ­£ç¡®å§¿åŠ¿";
    closeAddModal();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  $("closePay").addEventListener("click", closePayModal);
  $("noPayBtn").addEventListener("click", closePayModal);
  $("payModal").addEventListener("click", (e) => { if(e.target === $("payModal")) closePayModal(); });

  $("payBtn").addEventListener("click", () => {
    alert("æ¼”ç¤ºï¼šå·²å®Œæˆ 1 å…ƒä»£è®¸æ„¿æ”¯ä»˜ï¼ˆçº¿ä¸Šç‰ˆéœ€æ¥å¾®ä¿¡æ”¯ä»˜+è®¢å•ç³»ç»Ÿï¼‰ã€‚");
    closePayModal();
  });

  setUnlocked(unlocked);
  renderTodo();
</script>
</body>
</html>
