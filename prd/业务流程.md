# 拜拜小程序 - 业务流程

## 1. 启动流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌───────┐
│ 启动    │ ───▶ │ 开屏广告 │ ───▶ │ 引导页  │ ───▶ │ Tab页 │
│ 小程序  │      │ (5秒)   │      │ (3页)   │      │       │
└─────────┘      └─────────┘      └─────────┘      └───────┘
```

### 1.1 开屏广告
- **时长**：5秒（可跳过）
- **内容**：微信广告组件
- **操作**：倒计时结束后自动跳转，或点击"跳过"按钮

### 1.2 引导页
- **触发条件**：首次进入小程序
- **页数**：3页滑动引导
- **内容**：
  - 第1页：许愿有方法 - 分析愿望表达，找出缺失要素
  - 第2页：AI智能优化 - 一键生成规范许愿稿
  - 第3页：记录与追踪 - 管理愿望，见证实现
- **操作**：滑动浏览，最后一页点击"开始使用"进入首页

---

## 2. 核心业务流程

### 2.1 新增愿望流程

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│ 点击+新增│ ───▶ │ 填写愿望表单 │ ───▶ │ 点击确认记录 │
└─────────┘      │ (可选：分析) │      └──────┬──────┘
                │ (可选：AI优化)│             │
                └─────────────┘             │
                                            ▼
                                   ┌─────────────────┐
                                   │  跳转到愿望详情页 │
                                   │  (显示刚创建的)  │
                                   └─────────────────┘
```

**详细步骤**：

1. **入口**：
   - 首页：点击"新增愿望"按钮
   - 我的愿望页：点击底部"+新增愿望"按钮

2. **填写表单**：
   - 必填项：
     - 许愿人/受益人：选择这个愿望是为谁许的（自己/家人/孩子/姻缘/其他）
     - 对象：向谁许愿（如：观音菩萨、财神等）
     - 愿望原文：写下你的愿望
   - 建议项：时间范围、目标量化、方式边界、行动承诺
   - 可选项：还愿/回向
   
   **许愿人/受益人说明**：
   - 选择"自己"：为自己许愿，无需额外说明
   - 选择"家人"、"孩子"、"姻缘"、"其他"：需要填写具体说明（如"爸爸妈妈"、"我和老公"、"全家人"等）

3. **可选操作**：
   - **开始分析**：分析愿望缺失要素和潜在原因
   - **一键AI优化**：需要先解锁（看广告/分享），生成优化后的许愿稿

4. **确认记录**：
   - 点击"确认记录"后，保存到数据库
   - 自动跳转到愿望详情页，展示刚创建的愿望

---

### 2.2 查看愿望流程

```
┌─────────────┐      ┌─────────────────┐
│ 愿望列表页   │ ───▶ │  点击某个愿望卡片 │
└─────────────┘      └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  愿望详情页      │
                    │  - 查看完整信息  │
                    │  - 分析/AI优化   │
                    │  - 标记成功      │
                    │  - 编辑/删除     │
                    └─────────────────┘
```

**详细步骤**：

1. **入口**：
   - Tab 2：我的愿望页
   - 筛选：全部/进行中/已成功

2. **查看列表**：
   - 卡片式展示，包含：许愿人/受益人、对象、愿望原文、时间范围、目标量化、状态标签
   - 点击卡片进入详情页

3. **详情页功能**：
   - 查看完整愿望信息（所有字段）
   - 分析愿望（调用 AI 分析）
   - AI 优化（需解锁）
   - 标记为已成功
   - 编辑愿望
   - 删除愿望

---

### 2.3 愿望分析流程（首页）

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│ 输入愿望文本 │ ───▶ │ 点击开始分析 │ ───▶ │ 显示分析结果 │
└─────────────┘      └─────────────┘      └──────┬──────┘
                                                 │
                                                 ▼
                                        ┌─────────────────┐
                                        │  解锁正确姿势    │
                                        │  (看广告/分享)   │
                                        └──────┬──────────┘
                                               │
                                               ▼
                                        ┌─────────────────┐
                                        │  显示完整结果    │
                                        │  - 优化许愿稿    │
                                        │  - 建议步骤      │
                                        │  - 复制/记录     │
                                        └─────────────────┘
```

**详细步骤**：

1. **输入愿望**：
   - 在首页文本框中输入最近许过但没成功的愿望
   - 需要先登录

2. **开始分析**：
   - 点击"开始分析"按钮
   - 调用后端 API，使用大模型分析（优先 Qwen-Flash，备选 Kimi，最后 DeepSeek）
   - 同一次模型调用生成并缓存完整优化方案（前端暂不展示），用于分享/广告解锁后秒开
   - 显示加载状态

3. **分析结果**：
   - **缺失要素**：时间边界、量化目标、行动承诺等
   - **潜在原因/后果**：愿望过于抽象、目标不可验证等
   - **建议许愿对象**：根据愿望类型推荐更契合的对象（如学业→文殊、姻缘→月老、犯太岁→太岁）
   - **正确姿势**：锁定状态，需要解锁

4. **解锁方式**：
   - **看广告解锁**：观看激励视频广告
   - **分享解锁**：分享小程序给好友

5. **解锁后**：
   - 显示优化后的许愿稿
   - 显示建议步骤
   - 可复制许愿稿
   - 可记录到"我的愿望"

---

### 2.4 标记成功流程

```
┌─────────────┐      ┌─────────────────┐      ┌─────────────────┐
│ 愿望详情页   │ ───▶ │ 点击"标记成功"  │ ───▶ │ 弹出还愿弹窗    │
│             │      │                 │      │                 │
└─────────────┘      └─────────────────┘      │ - 恭喜达成！    │
                                                │ - 1元代还愿     │
                                                │ - 暂不需要      │
                                                └────────┬────────┘
                                                         │
                              ┌──────────────────────────┤
                              │                          │
                              ▼                          ▼
                     ┌─────────────────┐         ┌─────────────────┐
                     │ 支付成功         │         │ 关闭弹窗        │
                     │ 跳转到订单详情   │         │ 返回详情页      │
                     └─────────────────┘         │ (状态已更新)    │
                                                  └─────────────────┘
```

**详细步骤**：

1. **标记成功**：
   - 在愿望详情页点击"标记为已成功"按钮
   - 更新愿望状态为"已成功"

2. **弹出还愿弹窗**：
   - 恭喜用户愿望达成
   - 询问是否要"1元代还愿/回向"
   - 显示还愿稿（可编辑）
   - 显示备注输入框（可选）

3. **用户选择**：
   - **1元代还愿**：跳转微信支付，创建订单
   - **暂不需要**：关闭弹窗，返回详情页

4. **支付成功**：
   - 跳转到订单详情页（可选）
   - 或返回愿望详情页，显示"已还愿"状态

---

### 2.5 新增愿望弹窗内的分析流程

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│ 填写愿望表单 │ ───▶ │ 点击开始分析 │ ───▶ │ 显示诊断结果 │
└─────────────┘      └─────────────┘      └──────┬──────┘
                                                  │
                                                  ▼
                                         ┌─────────────────┐
                                         │  解锁AI优化     │
                                         │  (看广告/分享)  │
                                         └──────┬──────────┘
                                                │
                                                ▼
                                         ┌─────────────────┐
                                         │  显示优化结果    │
                                         │  - 优化许愿稿    │
                                         │  - 可复制        │
                                         └─────────────────┘
```

**详细步骤**：

1. **填写表单**：
   - 在新增愿望弹窗中填写愿望信息

2. **开始分析**：
   - 点击"开始分析"按钮
   - 分析当前填写的愿望原文
   - 显示诊断结果（缺失要素、潜在原因）

3. **AI优化**：
   - 需要先解锁（看广告/分享）
   - 解锁后显示优化后的许愿稿
   - 可复制许愿稿
   - 可继续编辑表单，或直接确认记录

---

## 3. 用户状态流转

### 3.1 愿望状态

```
未成功 (status=0)
    │
    │ 用户点击"标记成功"
    ▼
已成功 (status=1)
    │
    │ 用户选择"1元代还愿"
    ▼
已还愿 (order.status=已支付)
```

### 3.2 分析结果状态

```
未分析
    │
    │ 调用分析接口
    ▼
已分析（未解锁）
    │
    │ 看广告/分享解锁
    ▼
已解锁（可查看完整结果）
```

### 3.3 订单状态

```
待支付 (status=0)
    │
    │ 用户支付成功
    ▼
已支付 (status=1)
    │
    │ 服务完成
    ▼
已完成 (status=2)
```

---

## 4. 关键业务规则

### 4.1 解锁规则
- **解锁方式**：看广告、分享给好友
- **Token 有效期**：5分钟
- **一次性使用**：解锁后 token 立即失效
- **风控策略**：设备指纹 + 行为序列 + 频控 + 黑名单

### 4.2 分析规则
- **限流**：每个用户每天最多 N 次分析
- **内容安全**：必须通过微信内容安全 API 审核
- **AI 输出审核**：对模型返回内容也要进行安全审核

### 4.3 支付规则
- **金额**：1 元
- **用途**：代许愿/还愿回向
- **回调验证**：必须验签 + 去重 + 状态机推进
- **幂等性**：同一订单号只能支付一次

### 4.4 愿望管理规则
- **必填项**：许愿人/受益人、对象、愿望原文
- **受益人说明**：当选择"家人"、"孩子"、"姻缘"、"其他"时，需要填写具体说明
- **状态**：未成功(0) / 已成功(1)
- **编辑**：未成功的愿望可以编辑
- **删除**：所有愿望都可以删除（需确认）

---

## 5. 异常流程处理

### 5.1 登录失败
- **提示**：登录失败，请重试
- **操作**：允许重新登录

### 5.2 分析失败
- **提示**：分析失败，请稍后重试
- **操作**：允许重新分析

### 5.3 解锁失败
- **提示**：解锁失败，请重试
- **操作**：允许重新解锁（如果 token 未过期）

### 5.4 支付失败
- **提示**：支付失败，请重试
- **操作**：允许重新支付

### 5.5 网络错误
- **提示**：网络连接失败，请检查网络
- **操作**：允许重试

---

## 6. 数据流转

### 6.1 新增愿望
```
前端表单 → 云函数 API → 内容安全审核 → 保存到 wishes 集合 → 返回愿望 ID → 跳转详情页
```

### 6.2 分析愿望
```
前端输入 → 云函数 API → 内容安全审核 → 限流检查 → 调用模型 API（诊断+优化一次生成并缓存） → 
AI 输出安全审核 → 保存到 analyses 集合（含 full_result 缓存） → 生成解锁 token → 返回分析结果（full_result 仅缓存，不展示）
```

### 6.3 解锁
```
前端解锁请求 → 云函数 API → 验证 token → 风控检查 → 更新解锁状态 → 
读取并返回 analyses.full_result 缓存 → 前端立即显示
```

### 6.4 支付
```
前端创建订单 → 云函数 API → 创建订单记录 → 调用微信支付 → 返回支付参数 → 
前端调起支付 → 微信支付回调 → 验签 + 去重 → 更新订单状态 → 完成
```

---

## 7. 用户权限

### 7.1 未登录用户
- 可以查看首页（但不能分析）
- 可以查看引导页
- 不能访问"我的愿望"和"个人中心"

### 7.2 已登录用户
- 所有功能可用
- 可以创建、查看、编辑、删除自己的愿望
- 可以分析、解锁、支付

---

## 8. 数据统计

### 8.1 用户统计
- 总愿望数
- 已成功数
- 进行中数

### 8.2 业务统计
- 分析次数
- 解锁次数
- 支付订单数

---

## 9. 业务流程总结

| 流程 | 入口 | 关键操作 | 结果 |
|------|------|----------|------|
| 新增愿望 | 首页/我的愿望 | 填写表单 → 确认记录 | 跳转到愿望详情页 |
| 查看愿望 | 我的愿望页 | 点击愿望卡片 | 跳转到愿望详情页 |
| 分析愿望 | 首页 | 输入文本 → 开始分析 → 解锁 | 显示完整分析结果 |
| 标记成功 | 愿望详情页 | 点击标记成功 | 弹出还愿弹窗 |
| 支付还愿 | 还愿弹窗 | 1元代还愿 | 创建订单并支付 |
