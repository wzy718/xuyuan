# 微信小程序上线指南

本文档提供完整的微信小程序上线步骤，适用于使用微信云开发的项目。

## 📋 上线前检查清单

- [ ] 已在微信公众平台注册小程序并获取 AppID
- [ ] 已开通微信云开发并创建云环境
- [ ] 已获取大模型 API Key（GLM-4.5-Flash / Kimi / DeepSeek）
- [ ] 已配置云函数环境变量
- [ ] 已测试所有核心功能（分析、解锁、TODO、支付等）
- [ ] 已准备小程序基本信息（名称、简介、头像、类目等）

---

## 🚀 上线步骤

### 第一步：准备工作

#### 1.1 注册小程序并获取 AppID

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 注册小程序账号（如已注册，直接登录）
3. 在「设置」→「基本设置」中获取 **AppID**
4. 记录 AppID，后续需要配置到项目中

#### 1.2 开通云开发

1. 在微信公众平台，进入「云开发」→「云服务」
2. 点击「开通」创建云环境
3. 创建云环境后，记录 **环境 ID**（格式如：`cloud1-7gtd04o5108a99dd`）
4. 选择环境套餐（建议选择按量付费或包年包月）

#### 1.3 配置小程序基本信息

在微信公众平台「设置」→「基本设置」中配置：
- **小程序名称**：拜拜（或你的应用名称）
- **小程序简介**：愿望分析与许愿小程序
- **小程序头像**：上传 Logo 图片
- **服务类目**：选择合适类目（如：工具类、生活服务类等）

---

### 第二步：配置项目

#### 2.1 配置 AppID

编辑 `frontend/project.config.json`，确认 AppID 已正确配置：

```json
{
  "appid": "wxf5dcea93be742a21",  // 替换为你的 AppID
  ...
}
```

#### 2.2 配置云环境 ID

编辑 `frontend/config/prod.js`，确认云环境 ID 已配置：

```javascript
defineConstants: {
  CLOUD_ENV_ID: '"cloud1-7gtd04o5108a99dd"',  // 替换为你的云环境 ID
  ...
}
```

#### 2.3 配置广告位（可选）

如果已开通流量主并创建广告位，在 `frontend/config/prod.js` 中配置：

```javascript
defineConstants: {
  SPLASH_AD_UNIT_ID: '"adunit-xxxxxxxxxxxxxxxx"',      // 开屏广告位 ID
  BANNER_AD_UNIT_ID: '"adunit-xxxxxxxxxxxxxxxx"',      // 横幅广告位 ID
  INTERSTITIAL_AD_UNIT_ID: '"adunit-xxxxxxxxxxxxxxxx"', // 插屏广告位 ID
  ENABLE_AD_UNLOCK: 'true'  // 启用广告解锁功能
}
```

> **注意**：如果未开通流量主，保持 `ENABLE_AD_UNLOCK: 'false'`，广告位 ID 可留空。

---

### 第三步：配置云函数环境变量

#### 3.1 进入云开发控制台

1. 在微信公众平台，进入「云开发」→「云服务」
2. 选择你的云环境
3. 进入「云函数」→「环境变量」

#### 3.2 配置大模型 API Key

添加以下环境变量（至少配置一个）：

| 环境变量名 | 说明 | 是否必填 |
|-----------|------|---------|
| `ZHIPU_API_KEY` | 智谱 GLM-4.5-Flash API Key（推荐优先使用） | 推荐 |
| `MOONSHOT_API_KEY` | Kimi API Key（备选） | 可选 |
| `DEEPSEEK_API_KEY` | DeepSeek API Key（兜底） | 可选 |
| `LLM_PROVIDER` | 大模型提供商（auto/glm/zhipu/kimi/moonshot/deepseek） | 可选，默认 auto |

**配置示例**：
- `ZHIPU_API_KEY` = `your_zhipu_api_key_here`
- `LLM_PROVIDER` = `auto`（不配置则默认 auto，按 GLM→Kimi→DeepSeek 依次尝试）

> **安全提示**：API Key 必须通过云函数环境变量配置，禁止出现在前端代码中。

---

### 第四步：部署云函数

#### 4.1 打开微信开发者工具

1. 下载并安装 [微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
2. 使用管理员微信扫码登录

#### 4.2 导入项目

1. 打开微信开发者工具
2. 选择「小程序项目」→「导入项目」
3. 项目目录选择：`frontend/`（**不要选择 `dist/` 目录**）
4. AppID 选择：你的小程序 AppID
5. 点击「导入」

#### 4.3 上传并部署云函数

1. 在微信开发者工具左侧文件树中，找到 `cloudfunctions/api` 目录
2. **右键点击** `cloudfunctions/api` 目录
3. 选择「上传并部署：云端安装依赖」
4. 等待上传完成（首次上传可能需要几分钟）
5. 在云开发控制台「云函数」中确认函数已部署成功

> **注意**：如果云函数代码有更新，需要重新上传并部署。

---

### 第五步：构建前端代码

#### 5.1 安装依赖

在项目根目录执行：

```bash
cd frontend
npm install
```

#### 5.2 构建生产版本

```bash
npm run build:weapp
```

构建完成后，会在 `frontend/dist/` 目录生成小程序代码。

#### 5.3 检查构建产物

确认 `frontend/dist/` 目录下有以下文件：
- `app.js`、`app.json`、`app.wxss`
- `pages/` 目录（包含所有页面）
- `project.config.json`

---

### 第六步：上传代码

#### 6.1 在微信开发者工具中上传

1. 确保项目已正确导入（见第四步）
2. 在微信开发者工具顶部工具栏，点击「上传」按钮
3. 填写版本号和项目备注（如：v1.0.0 - 首次上线）
4. 点击「上传」

#### 6.2 确认上传成功

上传成功后，在微信公众平台「版本管理」→「开发版本」中可以看到刚上传的版本。

---

### 第七步：提交审核

#### 7.1 配置服务器域名（云开发无需配置）

> **注意**：使用云开发时，云函数调用走云开发通道，**无需配置服务器域名**。

如果使用自建后端，需要在「设置」→「开发设置」→「服务器域名」中配置：
- request合法域名
- uploadFile合法域名
- downloadFile合法域名

#### 7.2 配置业务域名（如需要）

如果小程序中使用了 web-view 组件，需要在「设置」→「开发设置」→「业务域名」中配置。

#### 7.3 提交审核

1. 在微信公众平台「版本管理」→「开发版本」中，找到刚上传的版本
2. 点击「提交审核」
3. 填写审核信息：
   - **版本描述**：简要说明本次版本的功能和更新内容
   - **测试账号**：如有需要，提供测试账号和密码
   - **测试路径**：提供测试路径（如：pages/index/index）
   - **测试说明**：详细说明测试步骤和注意事项
4. 上传小程序截图（至少 5 张，展示主要功能页面）
5. 点击「提交审核」

#### 7.4 等待审核

- 审核时间通常为 1-7 个工作日
- 可在「版本管理」→「审核版本」中查看审核状态
- 如审核被拒，查看拒绝原因并修改后重新提交

---

### 第八步：发布上线

#### 8.1 审核通过后发布

1. 审核通过后，在「版本管理」→「审核版本」中可以看到「审核通过」的版本
2. 点击「发布」按钮
3. 确认发布信息，点击「确认发布」

#### 8.2 全量发布

发布后，小程序会全量发布到线上，所有用户都可以访问。

#### 8.3 灰度发布（可选）

如果需要灰度发布，可以在「版本管理」中设置灰度比例，逐步放量。

---

## 🔍 上线后检查

### 功能检查清单

- [ ] 用户登录/认证功能正常
- [ ] 愿望分析功能正常（调用大模型）
- [ ] 解锁功能正常（广告/分享）
- [ ] 愿望列表 CRUD 功能正常
- [ ] 支付功能正常（如已接入）
- [ ] 分享功能正常
- [ ] 页面加载速度正常（<2s）
- [ ] 错误提示友好

### 监控检查

1. **云开发控制台监控**：
   - 查看云函数调用量和错误率
   - 查看云数据库读写量
   - 查看云存储使用量

2. **小程序数据统计**：
   - 在微信公众平台「统计」中查看用户数据
   - 关注访问量、留存率、错误率等指标

3. **日志排查**：
   - 在云开发控制台「云函数」→「日志」中查看错误日志
   - 及时处理异常情况

---

## ⚠️ 常见问题

### Q1: 云函数调用失败

**可能原因**：
- 云函数未正确部署
- 环境变量未配置
- 云环境 ID 配置错误

**解决方法**：
1. 检查云函数是否已上传并部署
2. 检查云函数环境变量是否配置正确
3. 检查 `frontend/config/prod.js` 中的 `CLOUD_ENV_ID` 是否正确
4. 查看云开发控制台「云函数」→「日志」中的错误信息

### Q2: 大模型调用失败

**可能原因**：
- API Key 未配置或配置错误
- API Key 余额不足
- 网络问题

**解决方法**：
1. 检查云函数环境变量中的 API Key 是否配置
2. 检查 API Key 是否有效（余额、权限等）
3. 查看云函数日志，确认具体错误信息

### Q3: 审核被拒

**常见原因**：
- 功能不完整或存在 Bug
- 类目选择不当
- 内容违规
- 缺少必要的用户协议或隐私政策

**解决方法**：
1. 仔细阅读审核反馈，了解拒绝原因
2. 修复 Bug 或完善功能
3. 调整类目或补充必要文档
4. 重新提交审核

### Q4: 支付功能异常

**可能原因**：
- 未配置微信支付商户号
- 支付回调未正确处理
- 订单状态更新失败

**解决方法**：
1. 确认已开通微信支付并配置商户号
2. 检查支付回调处理逻辑
3. 查看订单表状态，确认支付流程

---

## 📚 相关文档

- [部署文档](./DEPLOYMENT.md) - 详细的部署说明
- [快速开始](./QUICKSTART.md) - 开发环境搭建
- [故障排查](./TROUBLESHOOTING.md) - 常见问题排查
- [数据库设置](./DATABASE_SETUP.md) - 数据库配置说明

---

## 🎯 上线后优化建议

1. **性能优化**：
   - 监控页面加载时间，优化首屏渲染
   - 优化图片资源大小
   - 减少不必要的云函数调用

2. **用户体验优化**：
   - 收集用户反馈，持续改进
   - 优化错误提示和加载状态
   - 完善引导流程

3. **功能迭代**：
   - 根据用户需求添加新功能
   - 优化现有功能体验
   - 定期更新内容

4. **安全加固**：
   - 定期检查安全漏洞
   - 更新依赖包版本
   - 加强内容安全审核

---

## 📞 技术支持

如遇到问题，可以：
1. 查看 [故障排查文档](./TROUBLESHOOTING.md)
2. 查看微信开发者工具控制台日志
3. 查看云开发控制台日志
4. 参考 [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)

---

**祝上线顺利！** 🎉
