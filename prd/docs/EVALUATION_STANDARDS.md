# 愿望评价标准

## 评价维度（5个要素）

### 1. 时间边界
- **要求**：包含明确的时间信息
- **示例**：`3个月内`、`2026年内`、`今年`、`明年`、`本月`、`下月`、`近期`、`三个月内`、`半年内`
- **正则匹配**：`/(\d+\s*(天|周|星期|月|个月|年)|今年|明年|本月|下月|近期|三个月内|半年内)/`

### 2. 可验证的量化目标
- **要求**：包含数字和单位，使目标可验证
- **示例**：`8000元`、`100万`、`90分`、`前10名`、`3个offer`、`5家`、`2倍`、`80%`
- **正则匹配**：`/(\d+\s*(元|万|w|k|分|分数|名次|offer|家|单|倍|%))/i`

### 3. 方式与边界
- **要求**：明确合法合规、不伤害他人等边界
- **示例**：`合法`、`合规`、`不伤害`、`不害人`、`不违背良心`、`不以灾祸`、`不走偏门`
- **正则匹配**：`/(合法|合规|不伤害|不害人|不违背良心|不以灾祸|不走偏门)/`

### 4. 行动承诺
- **要求**：包含具体的行动承诺
- **示例**：`我会`、`我愿意`、`每天`、`每周`、`坚持`、`努力`、`学习`、`投递`、`锻炼`、`沟通`、`改进`
- **正则匹配**：`/(我会|我愿意|每天|每周|坚持|努力|学习|投递|锻炼|沟通|改进)/`

### 5. 还愿/回向（可选）
- **要求**：包含还愿、回向等表述，有助于形成闭环
- **示例**：`还愿`、`回向`、`布施`、`捐`、`供灯`、`行善`、`随喜`
- **正则匹配**：`/(还愿|回向|布施|捐|供灯|行善|随喜)/`

## 评价结果处理

### 符合标准（is_qualified = true）

当愿望包含所有必需要素（时间边界、量化目标、方式边界、行动承诺）时：

**返回内容：**
- **缺失要素**：`["基本要素齐全，可进一步润色表达"]` 或空数组
- **失败原因**：`["表达清晰，建议保持行动承诺并定期复盘"]` 或空数组
- **失败案例**：给出一个**成功案例**或正面案例（20-100字）
  - 示例：`某用户许愿"希望在3个月内找到月薪8000元以上的前端开发工作，我会每天投递5份简历并学习新技术，成功后我会还愿并捐款100元"。因为目标明确、时间清晰、行动具体，最终在2个月内成功入职心仪公司。`
- **正确姿势**：给出进一步优化建议或鼓励性建议（30字内）
  - 示例：`您的愿望表达已经很规范，建议继续保持并定期复盘进度，必要时可调整时间或目标`

### 不符合标准（is_qualified = false）

当愿望缺少必需要素时：

**返回内容：**
- **缺失要素**：列出缺失的要素，2-3条，每条15字内
- **失败原因**：列出失败原因，2-3条，每条15字内
- **失败案例**：给出一个真实具体的失败案例（20-100字）
  - 包含：谁、许了什么愿、为什么失败、结果如何
- **正确姿势**：给出具体可行的建议（30字内）

## AI Prompt 要求

系统会要求 AI 分析愿望并输出 JSON：

```json
{
  "missing": ["缺失要素1", "缺失要素2"],
  "reasons": ["失败原因1", "失败原因2"],
  "case": "类似失败案例的具体描述",
  "posture": "正确许愿姿势的简短建议",
  "is_qualified": true/false
}
```

### 输出规则

1. **如果符合标准（is_qualified=true）**：
   - `missing` 为空数组或 `["基本要素齐全，可进一步润色"]`
   - `reasons` 为空数组或 `["表达清晰，建议保持行动承诺并定期复盘"]`
   - `case` 给出成功案例或正面案例（20-100字）
   - `posture` 给出进一步优化建议或鼓励性建议（30字内）

2. **如果不符合标准（is_qualified=false）**：
   - `missing` 列出缺失的要素（2-3条，每条15字内）
   - `reasons` 列出失败原因（2-3条，每条15字内）
   - `case` 给出真实具体的失败案例（20-100字）
   - `posture` 给出具体可行的建议（30字内）

## 代码实现

**文件**：`frontend/cloudfunctions/api/index.js`

**函数**：`quickAnalyzeWish(wishText, deity = '')`

**处理逻辑**：
1. 调用大模型分析愿望（云函数默认 `auto`：优先 GLM-4.5-Flash，备选 Kimi，最后 DeepSeek）
2. 解析返回的 JSON，检查 `is_qualified` 字段
3. 根据 `is_qualified` 的值返回不同的结果：
   - `true`：返回正面反馈和成功案例
   - `false`：返回问题分析和失败案例

## 示例

### 符合标准的愿望

**输入**：`"希望在3个月内找到月薪8000元以上的前端开发工作，我会每天投递5份简历并学习新技术，通过合法途径实现，成功后我会还愿并捐款100元"`

**输出**：
- `missing`: `["基本要素齐全，可进一步润色表达"]`
- `reasons`: `["表达清晰，建议保持行动承诺并定期复盘"]`
- `case`: `"某用户许愿'希望在3个月内找到月薪8000元以上的前端开发工作，我会每天投递5份简历并学习新技术，成功后我会还愿并捐款100元'。因为目标明确、时间清晰、行动具体，最终在2个月内成功入职心仪公司。"`
- `posture`: `"您的愿望表达已经很规范，建议继续保持并定期复盘进度，必要时可调整时间或目标"`

### 不符合标准的愿望

**输入**：`"希望找到好工作"`

**输出**：
- `missing`: `["时间边界", "可验证的量化目标", "方式与边界", "行动承诺"]`
- `reasons`: `["表达过于抽象", "目标不可验证", "缺少截止时间"]`
- `case`: `"某用户许愿'希望找到好工作'，但未明确具体岗位、薪资范围和时间期限。半年后仍未找到满意工作，因为目标模糊导致求职方向不明确，投递简历时缺乏针对性，最终只能接受一份并不理想的工作。"`
- `posture`: `"明确目标、设定时间、承诺行动、许下还愿"`
