# 拜拜小程序 - 产品需求文档（PRD）

## 1. 产品概述

### 1.1 产品定位
拜拜是一款基于 AI 的愿望分析与优化小程序，帮助用户：
- 分析许愿表达中的缺失要素
- 提供 AI 智能优化建议
- 管理愿望记录，追踪实现情况
- 提供代许愿/还愿回向服务

### 1.2 目标用户
- 有许愿需求的用户
- 希望规范许愿表达的用户
- 需要管理愿望记录的用户

### 1.3 核心价值
- **表达优化**：通过 AI 分析，找出愿望表达中的缺失要素
- **智能建议**：生成规范的许愿稿，提供建议步骤
- **愿望管理**：记录和管理每一个愿望，追踪实现情况
- **还愿服务**：提供 1 元代许愿/还愿回向服务

---

## 2. 功能需求

### 2.1 启动流程

#### 2.1.1 开屏广告
- **触发**：小程序启动时
- **时长**：5秒（可跳过）
- **内容**：微信广告组件
- **操作**：倒计时结束后自动跳转，或点击"跳过"按钮

#### 2.1.2 引导页
- **触发**：首次进入小程序
- **页数**：3页滑动引导
- **内容**：
  - 第1页：许愿有方法 - 分析愿望表达，找出缺失要素
  - 第2页：AI智能优化 - 一键生成规范许愿稿
  - 第3页：记录与追踪 - 管理愿望，见证实现
- **操作**：滑动浏览，最后一页点击"开始使用"进入首页

---

### 2.2 首页（Tab 1）- 愿望分析

#### 2.2.1 横幅广告
- **位置**：首页顶部
- **内容**：微信广告组件
- **展示**：登录后显示

#### 2.2.2 愿望输入
- **功能**：输入最近许过但没成功的愿望
- **要求**：需要先登录
- **操作**：点击"开始分析"按钮

#### 2.2.3 分析结果
- **缺失要素**：时间边界、量化目标、行动承诺等
- **潜在原因**：愿望过于抽象、目标不可验证等
- **正确姿势**：锁定状态，需要解锁

#### 2.2.4 解锁功能
- **解锁方式**：
  - 看广告解锁：观看激励视频广告
  - 分享解锁：分享小程序给好友
- **体验优化**：分析阶段同一次模型调用生成并缓存完整优化方案，解锁后直接展示，保证秒开
- **解锁后**：显示优化后的许愿稿、建议步骤
- **操作**：可复制许愿稿、可记录到"我的愿望"

---

### 2.3 我的愿望（Tab 2）- 愿望管理

#### 2.3.1 愿望列表
- **展示方式**：卡片式列表
- **筛选**：全部/进行中/已成功
- **信息**：许愿人/受益人、对象、愿望原文、时间范围、目标量化、状态标签

#### 2.3.2 愿望卡片操作
- **查看详情**：点击卡片进入详情页
- **分析**：点击"分析"按钮，分析愿望
- **标记成功**：点击"成功"按钮，标记为已成功
- **删除**：点击"删除"按钮，删除愿望

#### 2.3.3 新增愿望
- **入口**：底部"+新增愿望"按钮
- **功能**：打开新增愿望弹窗

---

### 2.4 愿望详情页

#### 2.4.1 愿望信息展示
- **基本信息**：许愿人/受益人、对象、愿望原文、状态标签
- **愿望要素**：时间范围、目标量化、方式边界、行动承诺、还愿/回向
- **时间记录**：许愿时间、截止时间（进行中）/达成时间（已成功）、剩余天数/用时

#### 2.4.2 操作功能
- **分析/AI优化**：分析愿望，生成优化建议
- **标记成功**：标记愿望为已成功（进行中的愿望）
- **编辑愿望**：编辑愿望信息（未成功的愿望）
- **删除愿望**：删除愿望
- **复制许愿稿**：复制优化后的许愿稿（已成功的愿望）
- **分享给好友**：分享愿望（已成功的愿望）

#### 2.4.3 还愿状态（已成功的愿望）
- **还愿状态**：未还愿/已还愿
- **还愿操作**：点击"1元代还愿"按钮，弹出还愿支付弹窗

---

### 2.5 新增愿望弹窗

#### 2.5.1 表单字段
- **必填项**：
  - 许愿人/受益人：选择这个愿望是为谁许的（自己/家人/孩子/姻缘/其他）
  - 对象：向谁许愿（如：观音菩萨、财神等）
  - 愿望原文：写下你的愿望
- **建议项**：时间范围、目标量化、方式边界、行动承诺
- **可选项**：还愿/回向

#### 2.5.1.1 许愿人/受益人说明
- **自己**：为自己许愿
- **家人**：为家人许愿（如：爸爸妈妈、爷爷奶奶等），需要填写具体说明
- **孩子**：为孩子许愿，需要填写具体说明
- **姻缘**：求姻缘（涉及两个人），需要填写具体说明
- **其他**：其他情况（如：团队、多人等），需要填写具体说明

#### 2.5.2 分析功能
- **开始分析**：分析愿望缺失要素和潜在原因
- **诊断结果**：显示缺失要素、潜在原因、优化建议

#### 2.5.3 AI优化功能
- **解锁方式**：看广告/分享解锁
- **优化结果**：生成优化后的许愿稿
- **操作**：可复制许愿稿

#### 2.5.4 确认记录
- **操作**：点击"确认记录"按钮
- **结果**：保存到数据库，跳转到愿望详情页

---

### 2.6 还愿支付弹窗

#### 2.6.1 触发条件
- 在愿望详情页点击"标记成功"后弹出
- 或在已成功的愿望详情页点击"1元代还愿"

#### 2.6.2 弹窗内容
- **恭喜信息**：恭喜愿望达成
- **还愿说明**：1元代许愿/还愿回向服务说明
- **表单字段**：
  - 对象（可编辑）
  - 还愿稿（可编辑）
  - 备注（可选）

#### 2.6.3 支付操作
- **1元代还愿**：跳转微信支付，创建订单
- **暂不需要**：关闭弹窗，返回详情页

---

### 2.7 个人中心（Tab 3）

#### 2.7.1 用户信息
- **头像**：用户头像
- **昵称**：用户昵称
- **ID**：用户ID

#### 2.7.2 统计数据
- **总愿望数**：所有愿望数量
- **已成功数**：已成功的愿望数量
- **进行中数**：进行中的愿望数量

#### 2.7.3 功能菜单
- **我的订单**：查看支付订单列表
- **消息通知**：查看系统消息
- **设置**：应用设置
- **使用帮助**：使用说明
- **意见反馈**：提交反馈
- **关于我们**：产品信息

---

## 3. 非功能需求

### 3.1 性能要求
- 页面加载时间 < 2秒
- 分析响应时间 < 5秒
- 操作响应时间 < 1秒

### 3.2 安全要求
- API Key 保护：DeepSeek API Key 必须通过云函数环境变量配置
- 内容安全：必须调用微信内容安全 API
- 限流保护：用户级别限流（每天最多 N 次）
- 解锁风控：设备指纹 + 行为序列 + 频控 + 黑名单
- 支付安全：支付回调必须验签 + 去重 + 状态机推进

### 3.3 兼容性要求
- 支持微信小程序最新版本
- 支持 iOS 和 Android 系统

### 3.4 可用性要求
- 错误提示要友好
- 加载状态要明确
- 操作反馈要及时

---

## 4. 业务流程

详细业务流程请参考：[业务流程.md](./业务流程.md)

### 4.1 核心流程
1. **新增愿望**：填写表单 → 确认记录 → 跳转到愿望详情页
2. **查看愿望**：列表点击卡片 → 跳转到愿望详情页
3. **分析愿望**：输入文本 → 开始分析 → 解锁 → 显示完整结果
4. **标记成功**：点击标记成功 → 弹出还愿弹窗
5. **支付还愿**：1元代还愿 → 创建订单并支付

---

## 5. 页面设计

详细页面设计请参考：[页面设计.md](./页面设计.md)

### 5.1 页面列表
- 开屏广告页
- 引导页（3页）
- 首页（Tab 1）
- 我的愿望（Tab 2）
- 愿望详情页
- 个人中心（Tab 3）
- 新增愿望弹窗
- 还愿支付弹窗

### 5.2 视觉风格
- **风格**：禅意中式
- **主色调**：檀金、朱砂、月白、墨色、竹青
- **装饰元素**：祥云纹理、莲花图案、回纹边框

---

## 6. 数据模型

### 6.1 用户表 (users)
- `_id`: 主键
- `_openid`: 微信 OPENID
- `nickname`: 昵称
- `avatar_url`: 头像
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 6.2 愿望表 (wishes)
- `_id`: 主键
- `_openid`: 用户 OPENID
- `beneficiary_type`: 许愿人/受益人类型（self/自己、family/家人、child/孩子、couple/姻缘、other/其他）
- `beneficiary_desc`: 受益人具体说明（可选，当类型为家人/孩子/姻缘/其他时填写，如"爸爸妈妈"、"我和老公"、"全家人"）
- `deity`: 对象（向谁许愿）
- `wish_text`: 愿望原文
- `time_range`: 时间范围
- `target_quantify`: 目标量化
- `way_boundary`: 方式边界
- `action_commitment`: 行动承诺
- `return_wish`: 还愿/回向
- `status`: 状态（0:未成功 1:已成功）
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 6.3 分析记录表 (analyses)
- `_id`: 主键
- `_openid`: 用户 OPENID
- `wish_id`: 关联愿望 ID（可选）
- `wish_text`: 愿望原文
- `analysis_result`: 分析结果（JSON）
- `full_result`: 完整结果（解锁后，JSON）
- `unlocked`: 是否已解锁
- `unlock_token`: 解锁 token
- `unlock_token_expires_at`: token 过期时间
- `unlock_token_used`: token 是否已使用
- `created_at`: 创建时间

### 6.4 订单表 (orders)
- `_id`: 主键
- `_openid`: 用户 OPENID
- `wish_id`: 关联愿望 ID
- `amount`: 金额（分）
- `status`: 状态（0:待支付 1:已支付 2:已完成 3:已退款）
- `payment_id`: 微信支付订单号
- `out_trade_no`: 商户订单号
- `transaction_id`: 微信支付交易号
- `callback_received`: 是否已收到回调
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 6.5 解锁日志表 (unlock_logs)
- `_id`: 主键
- `_openid`: 用户 OPENID
- `analysis_id`: 分析记录 ID
- `unlock_type`: 解锁类型（ad/share）
- `device_fingerprint`: 设备指纹
- `created_at`: 创建时间

---

## 7. API 接口

### 7.1 用户相关
- `auth.login` - 用户登录
- `auth.refresh` - 刷新 token
- `user.profile` - 获取用户信息

### 7.2 愿望分析
- `wish.analyze` - 分析愿望
- `wish.optimize` - 优化愿望（需解锁）

### 7.3 愿望管理
- `todos.list` - 获取愿望列表
- `todos.create` - 新增愿望
- `todos.update` - 更新愿望
- `todos.delete` - 删除愿望

### 7.4 解锁相关
- `unlock.ad` - 看广告解锁
- `unlock.share` - 分享解锁
- `unlock.status` - 查询解锁状态

### 7.5 支付相关
- `payment.create` - 创建支付订单
- `payment.callback` - 支付回调

---

## 8. 技术架构

详细技术架构请参考：[架构设计.md](./架构设计.md)

### 8.1 前端
- **框架**：Taro 3.x
- **语言**：TypeScript + React
- **状态管理**：Zustand
- **样式**：SCSS

### 8.2 后端（云开发）
- **云函数**：Node.js（统一入口：`cloudfunctions/api`）
- **云数据库**：微信云数据库
- **外部服务**：DeepSeek API

---

## 9. 开发计划

### Phase 1：核心功能（MVP）
1. ✅ 用户登录（微信授权）
2. ✅ 愿望分析接口（调用 DeepSeek）
3. ✅ TODO 列表 CRUD
4. ✅ 基础内容安全过滤

### Phase 2：解锁功能
1. ✅ 解锁 token 生成与验证
2. ✅ 广告解锁风控
3. ✅ 分享解锁风控
4. ✅ 解锁状态管理

### Phase 3：支付功能
1. ✅ 微信支付集成
2. ✅ 订单管理
3. ✅ 支付回调处理

### Phase 4：优化
1. ⏳ 缓存优化
2. ⏳ 限流完善
3. ⏳ 数据分析
4. ⏳ 性能优化

---

## 10. 相关文档

- [业务流程.md](./业务流程.md) - 详细业务流程说明
- [页面设计.md](./页面设计.md) - 页面设计 ASCII 图
- [架构设计.md](./架构设计.md) - 技术架构设计

---

## 11. 更新记录

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|----------|--------|
| 2025-01-XX | 1.0 | 初始版本 | - |
