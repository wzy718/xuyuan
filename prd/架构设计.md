# æ‹œæ‹œå°ç¨‹åºæ¶æ„è®¾è®¡

## 1. æ¶æ„å†³ç­–ï¼šå‰åç«¯åˆ†ç¦»ï¼ˆå¿…é¡»ï¼‰

### 1.1 ä¸ºä»€ä¹ˆå¿…é¡»å‰åç«¯åˆ†ç¦»ï¼Ÿ

#### ğŸ”’ å®‰å…¨æ€§è¦æ±‚
- **API Key ä¿æŠ¤**ï¼šDeepSeek API Key ç»å¯¹ä¸èƒ½æš´éœ²åœ¨å°ç¨‹åºå‰ç«¯ä»£ç ä¸­
  - å°ç¨‹åºä»£ç å¯è¢«åç¼–è¯‘ï¼Œå‰ç«¯å­˜å‚¨çš„å¯†é’¥ä¼šè¢«æ³„éœ²
  - ä¸€æ—¦æ³„éœ²ï¼Œå¯èƒ½å¯¼è‡´ API è¢«æ»¥ç”¨ï¼Œäº§ç”Ÿé«˜é¢è´¹ç”¨
- **æ•°æ®å®‰å…¨**ï¼šç”¨æˆ·æ„¿æœ›æ•°æ®éœ€è¦åŠ å¯†å­˜å‚¨å’Œä¼ è¾“

#### ğŸ›¡ï¸ å†…å®¹å®‰å…¨
- **å†…å®¹å®¡æ ¸**ï¼šéœ€è¦åœ¨åç«¯å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œå®‰å…¨è¿‡æ»¤
  - æ‹’ç»ï¼šä¼¤å®³ä»–äººã€è¿æ³•ã€èµŒåšã€è¯ˆéª—ã€ä»‡æ¨ç­‰å†…å®¹
  - è½¯åŠé˜»ï¼šæ§åˆ¶ä»–äºº/æç«¯æ‰§å¿µç­‰ä¸å½“å†…å®¹
- **åˆè§„è¦æ±‚**ï¼šç¬¦åˆå¾®ä¿¡å°ç¨‹åºå†…å®¹å®‰å…¨è§„èŒƒ

#### ğŸ’° æˆæœ¬æ§åˆ¶
- **é™æµä¿æŠ¤**ï¼šé˜²æ­¢å•ä¸ªç”¨æˆ·æ¶æ„åˆ· API è°ƒç”¨
- **è°ƒç”¨ç»Ÿè®¡**ï¼šç›‘æ§ API ä½¿ç”¨é‡ï¼Œæ§åˆ¶æˆæœ¬
- **è§£é”éªŒè¯**ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦çœŸçš„çœ‹äº†å¹¿å‘Š/åˆ†äº«äº†ï¼Œé˜²æ­¢åˆ·è§£é”

#### ğŸ’¾ æ•°æ®å­˜å‚¨
- **TODO åˆ—è¡¨**ï¼šéœ€è¦æŒä¹…åŒ–å­˜å‚¨ç”¨æˆ·çš„æ„¿æœ›è®°å½•
- **ç”¨æˆ·çŠ¶æ€**ï¼šè§£é”çŠ¶æ€ã€æ”¯ä»˜è®°å½•ç­‰éœ€è¦åç«¯ç®¡ç†
- **åˆ†æå†å²**ï¼šä¿å­˜ç”¨æˆ·çš„åˆ†æè®°å½•ï¼ˆå¯é€‰ï¼Œç”¨äºä¼˜åŒ–ä½“éªŒï¼‰

---

## 2. æ¨èæ¶æ„æ–¹æ¡ˆ

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾®ä¿¡å°ç¨‹åºå‰ç«¯   â”‚
â”‚  (Taro/åŸç”Ÿ)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTPS
         â”‚ å¾®ä¿¡ç™»å½•
         â”‚ API è°ƒç”¨
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯ API æœåŠ¡   â”‚
â”‚  (Node.js/Python)â”‚
â”‚                  â”‚
â”‚  - ç”¨æˆ·è®¤è¯       â”‚
â”‚  - å†…å®¹å®‰å…¨       â”‚
â”‚  - é™æµæ§åˆ¶       â”‚
â”‚  - æ•°æ®å­˜å‚¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º DeepSeek API (AI åˆ†æ)
         â”œâ”€â”€â–º å¾®ä¿¡æ”¯ä»˜ API (1 å…ƒæ”¯ä»˜)
         â”œâ”€â”€â–º æ•°æ®åº“ (MySQL/MongoDB)
         â””â”€â”€â–º å¯¹è±¡å­˜å‚¨ (å¯é€‰ï¼Œå­˜å›¾ç‰‡ç­‰)
```

### 2.2 æŠ€æœ¯æ ˆæ¨è

#### å‰ç«¯ï¼ˆå°ç¨‹åºï¼‰
- **æ¡†æ¶**ï¼šTaroï¼ˆè·¨ç«¯ï¼‰æˆ– åŸç”Ÿå¾®ä¿¡å°ç¨‹åº
- **çŠ¶æ€ç®¡ç†**ï¼šZustand æˆ– MobXï¼ˆè½»é‡ï¼‰
- **UI ç»„ä»¶**ï¼šTaro UI æˆ– Vant Weapp

#### åç«¯
- **è¯­è¨€**ï¼šNode.js (Express/Koa) æˆ– Python (FastAPI/Flask)
- **æ•°æ®åº“**ï¼š
  - **MySQL**ï¼šå­˜å‚¨ç”¨æˆ·æ•°æ®ã€TODO åˆ—è¡¨ã€è®¢å•ç­‰ç»“æ„åŒ–æ•°æ®
  - **Redis**ï¼šç¼“å­˜ã€é™æµã€è§£é”çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
- **API ç½‘å…³**ï¼šNginx æˆ–äº‘æœåŠ¡å•†æä¾›çš„ç½‘å…³

#### éƒ¨ç½²
- **åç«¯**ï¼šäº‘æœåŠ¡å™¨ï¼ˆé˜¿é‡Œäº‘/è…¾è®¯äº‘ï¼‰æˆ– Serverlessï¼ˆäº‘å‡½æ•°ï¼‰
- **æ•°æ®åº“**ï¼šäº‘æ•°æ®åº“ RDS
- **CDN**ï¼šé™æ€èµ„æºåŠ é€Ÿï¼ˆå¯é€‰ï¼‰

---

## 3. API æ¥å£è®¾è®¡

### 3.1 æ ¸å¿ƒæ¥å£åˆ—è¡¨

#### ç”¨æˆ·ç›¸å…³
```
POST /api/auth/login          # å¾®ä¿¡ç™»å½•ï¼ˆcode2sessionï¼‰
POST /api/auth/refresh       # åˆ·æ–° access_token
GET  /api/user/profile        # è·å–ç”¨æˆ·ä¿¡æ¯
```

#### æ„¿æœ›åˆ†æ
```
POST /api/wish/analyze        # åˆ†ææ„¿æœ›ï¼ˆè°ƒç”¨ DeepSeekï¼‰
POST /api/wish/optimize       # AI ä¼˜åŒ–æ„¿æœ›ï¼ˆéœ€è§£é”ï¼‰
```

#### TODO ç®¡ç†
```
GET    /api/todos             # è·å–æ„¿æœ›åˆ—è¡¨
POST   /api/todos             # æ–°å¢æ„¿æœ›
PUT    /api/todos/:id         # æ›´æ–°æ„¿æœ›ï¼ˆæ ‡è®°æˆåŠŸç­‰ï¼‰
DELETE /api/todos/:id         # åˆ é™¤æ„¿æœ›
```

#### è§£é”ç›¸å…³
```
POST /api/unlock/ad           # çœ‹å¹¿å‘Šè§£é”
POST /api/unlock/share        # åˆ†äº«è§£é”
GET  /api/unlock/status       # æŸ¥è¯¢è§£é”çŠ¶æ€
```

#### æ”¯ä»˜ç›¸å…³
```
POST /api/payment/create      # åˆ›å»ºæ”¯ä»˜è®¢å•
POST /api/payment/callback    # æ”¯ä»˜å›è°ƒï¼ˆå¾®ä¿¡æœåŠ¡å™¨è°ƒç”¨ï¼‰
```

### 3.2 å…³é”®æ¥å£è¯¦ç»†è®¾è®¡

#### POST /api/wish/analyze
**è¯·æ±‚**ï¼š
```json
{
  "wish_text": "æˆ‘æƒ³ä¸­å½©ç¥¨",
  "deity": "è´¢ç¥",
  "profile": {
    "name": "å¼ ä¸‰",
    "city": "åŒ—äº¬"
  }
}
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "data": {
    "analysis_id": 123,  // åˆ†æè®°å½• ID
    "missing_elements": ["æ—¶é—´èŒƒå›´", "ç›®æ ‡é‡åŒ–"],
    "possible_reasons": ["è¡¨è¾¾è¿‡äºæŠ½è±¡", "ç›®æ ‡ä¸å¯éªŒè¯"],
    "locked": true,  // æ˜¯å¦é”å®š
    "unlock_token": "xxx",  // è§£é” tokenï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼Œä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
    "unlock_token_expires_at": 1699999999,  // token è¿‡æœŸæ—¶é—´æˆ³
    "full_result": {  // å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆï¼ˆä»…ç”¨äºå‰ç«¯ç¼“å­˜ï¼Œå±•ç¤ºä»éœ€è§£é”ï¼‰
      "optimized_text": "...",
      "structured_suggestion": { "time_range": "...", "target_quantify": "..." },
      "steps": ["..."],
      "warnings": []
    }
  }
}
```

**åç«¯å¤„ç†æµç¨‹**ï¼š
1. éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆéªŒè¯ access_tokenï¼Œè·å– user_idï¼‰
2. **å†…å®¹å®‰å…¨å®¡æ ¸**ï¼ˆâš ï¸ é‡è¦ï¼‰ï¼š
   - è°ƒç”¨å¾®ä¿¡å†…å®¹å®‰å…¨ APIï¼ˆ`msgSecCheck`ï¼‰
   - è‡ªå®šä¹‰è§„åˆ™è¿‡æ»¤ï¼ˆå…³é”®è¯ã€æ•æ„Ÿè¯åº“ï¼‰
   - é˜²æ­¢æç¤ºè¯æ³¨å…¥ï¼ˆè¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ã€é™åˆ¶é•¿åº¦ï¼‰
3. é™æµæ£€æŸ¥ï¼ˆRedis è®°å½•ç”¨æˆ·è°ƒç”¨æ¬¡æ•°ï¼‰
4. è°ƒç”¨ DeepSeek API
5. **æ¨¡å‹è¾“å‡ºå®‰å…¨å®¡æ ¸**ï¼ˆâš ï¸ é‡è¦ï¼‰ï¼š
   - å¯¹ DeepSeek è¿”å›çš„å†…å®¹ä¹Ÿè¦åšå®‰å…¨å®¡æ ¸
   - è¿‡æ»¤ä¸å½“å»ºè®®ã€è¿æ³•å†…å®¹
6. è§£æå¹¶ç»“æ„åŒ–è¿”å›ç»“æœ
7. ä¿å­˜åˆ†æè®°å½•åˆ° `analyses` è¡¨ï¼š
   - å¦‚æœ `wish_id` å­˜åœ¨ï¼Œå…³è”æ„¿æœ›è®°å½•
   - å¦‚æœæ˜¯ä¸€æ¬¡æ€§è¯·æ±‚ï¼Œ`wish_id` ä¸º NULL
8. ç”Ÿæˆ `unlock_token`ï¼ˆç»‘å®š `user_id` + `analysis_id`ï¼Œ5åˆ†é’Ÿè¿‡æœŸï¼‰
9. è¿”å›ç»“æœï¼ˆå®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆåœ¨åˆ†æé˜¶æ®µåŒä¸€æ¬¡æ¨¡å‹è°ƒç”¨ç”Ÿæˆå¹¶ç¼“å­˜ï¼›å‰ç«¯ä»…ç¼“å­˜ä¸å±•ç¤ºï¼Œè§£é”åç§’å¼€ï¼‰

#### POST /api/unlock/ad
**è¯·æ±‚**ï¼š
```json
{
  "unlock_token": "xxx",  // ä» analyze æ¥å£è·å–
  "analysis_id": 123,  // åˆ†æè®°å½• IDï¼ˆç”¨äºéªŒè¯ï¼‰
  "ad_info": {  // å¹¿å‘Šä¿¡æ¯ï¼ˆå‰ç«¯ä¸ŠæŠ¥ï¼Œä»…ä½œå‚è€ƒï¼‰
    "ad_id": "xxx",
    "duration": 30,  // è§‚çœ‹æ—¶é•¿ï¼ˆç§’ï¼‰
    "completed": true  // æ˜¯å¦å®Œæ•´è§‚çœ‹
  },
  "device_fingerprint": "xxx"  // è®¾å¤‡æŒ‡çº¹ï¼ˆç”¨äºé£æ§ï¼‰
}
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "data": {
    "unlocked": true,
    "full_result": {
      "optimized_text": "...",
      "structured_suggestion": {...},
      "steps": [...]
    }
  }
}
```

**åç«¯å¤„ç†æµç¨‹**ï¼š
1. **âš ï¸ é‡è¦**ï¼šå¹¿å‘Š/åˆ†äº«è§£é”æ— æ³•åšåˆ°å¼ºéªŒè¯ï¼Œåªèƒ½åšé£æ§æ¦‚ç‡æ­£ç¡®
   - å¾®ä¿¡æ¿€åŠ±è§†é¢‘å¹¿å‘Šå’Œåˆ†äº«è¡Œä¸ºé€šå¸¸æ²¡æœ‰å¯é çš„æœåŠ¡ç«¯éªŒè¯ API
   - åªèƒ½ä¾èµ–å‰ç«¯å›è°ƒ + å¼±ä¿¡å·éªŒè¯
   - å»ºè®®é‡‡ç”¨ï¼šè®¾å¤‡æŒ‡çº¹ + è¡Œä¸ºåºåˆ— + é¢‘æ§ + é»‘åå•çš„é£æ§ç­–ç•¥
2. éªŒè¯è§£é” token æœ‰æ•ˆæ€§ï¼ˆè§ä¸‹æ–¹è§£é” token è®¾è®¡ï¼‰
3. é£æ§æ£€æŸ¥ï¼š
   - æ£€æŸ¥è®¾å¤‡æŒ‡çº¹æ˜¯å¦å¼‚å¸¸
   - æ£€æŸ¥è§£é”é¢‘ç‡ï¼ˆåŒä¸€ç”¨æˆ·/è®¾å¤‡çŸ­æ—¶é—´å†…è§£é”æ¬¡æ•°ï¼‰
   - æ£€æŸ¥è¡Œä¸ºåºåˆ—ï¼ˆæ˜¯å¦æ­£å¸¸æµè§ˆæµç¨‹ï¼‰
4. è®°å½•è§£é”çŠ¶æ€ï¼ˆRedis æˆ–æ•°æ®åº“ï¼Œæ ‡è®°å·²ä½¿ç”¨ï¼‰
5. è¿”å›å®Œæ•´åˆ†æç»“æœ

---

## 4. æ•°æ®åº“è®¾è®¡ï¼ˆç®€åŒ–ç‰ˆï¼‰

### 4.1 ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  openid VARCHAR(64) UNIQUE NOT NULL,  -- å¾®ä¿¡ openid
  unionid VARCHAR(64),  -- å¾®ä¿¡ unionidï¼ˆå¯é€‰ï¼‰
  nickname VARCHAR(64),
  avatar_url VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 4.2 æ„¿æœ›è¡¨ (wishes/todos)
```sql
CREATE TABLE wishes (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  deity VARCHAR(32),  -- å¯¹è±¡
  wish_text TEXT NOT NULL,  -- æ„¿æœ›åŸæ–‡
  time_range VARCHAR(128),  -- æ—¶é—´èŒƒå›´
  target_quantify VARCHAR(128),  -- ç›®æ ‡é‡åŒ–
  way_boundary VARCHAR(128),  -- æ–¹å¼è¾¹ç•Œ
  action_commitment VARCHAR(128),  -- è¡ŒåŠ¨æ‰¿è¯º
  return_wish TEXT,  -- è¿˜æ„¿/å›å‘
  status TINYINT DEFAULT 0,  -- 0:æœªæˆåŠŸ 1:å·²æˆåŠŸ
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_status (status)
);
```

### 4.3 åˆ†æè®°å½•è¡¨ (analyses)
```sql
CREATE TABLE analyses (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  wish_id BIGINT,  -- âš ï¸ å…³è”æ„¿æœ› IDï¼ˆå¦‚æœæ˜¯ä¸€æ¬¡æ€§è¯·æ±‚åˆ™ä¸º NULLï¼‰
  wish_text TEXT NOT NULL,  -- æ„¿æœ›åŸæ–‡ï¼ˆå¦‚æœ wish_id å­˜åœ¨ï¼Œå¯ä» wishes è¡¨å…³è”è·å–ï¼‰
  analysis_result JSON,  -- åˆ†æç»“æœï¼ˆç¼ºå¤±è¦ç´ ã€åŸå› ç­‰ï¼‰
  full_result JSON,  -- å®Œæ•´ç»“æœï¼ˆåˆ†æé˜¶æ®µé¢„ç”Ÿæˆç¼“å­˜ï¼Œè§£é”åå±•ç¤ºï¼‰
  unlocked BOOLEAN DEFAULT FALSE,
  unlock_token VARCHAR(64) UNIQUE,  -- è§£é” tokenï¼ˆçŸ­è¿‡æœŸã€ä¸€æ¬¡æ€§ï¼‰
  unlock_token_expires_at TIMESTAMP,  -- token è¿‡æœŸæ—¶é—´
  unlock_token_used BOOLEAN DEFAULT FALSE,  -- token æ˜¯å¦å·²ä½¿ç”¨ï¼ˆé˜²é‡æ”¾ï¼‰
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_wish_id (wish_id),
  INDEX idx_unlock_token (unlock_token)
);
```

**âš ï¸ æ•°æ®æ¨¡å‹ä¸€è‡´æ€§è¯´æ˜**ï¼š
- `analyses` è¡¨é€šè¿‡ `wish_id` å…³è” `wishes` è¡¨ï¼Œé¿å…é‡å¤å­˜å‚¨æ„¿æœ›åŸæ–‡
- å¦‚æœæ˜¯ä¸€æ¬¡æ€§åˆ†æè¯·æ±‚ï¼ˆä¸ä¿å­˜åˆ° TODOï¼‰ï¼Œ`wish_id` ä¸º NULLï¼Œ`wish_text` ç›´æ¥å­˜å‚¨
- å¦‚æœæ˜¯ä» TODO åˆ—è¡¨å‘èµ·çš„åˆ†æï¼Œ`wish_id` å…³è”å¯¹åº”æ„¿æœ›ï¼Œ`wish_text` å¯ä»å…³è”è¡¨è·å–ï¼ˆä½†ä¸ºæŸ¥è¯¢æ€§èƒ½ä¹Ÿå¯å†—ä½™å­˜å‚¨ï¼‰

### 4.4 è®¢å•è¡¨ (orders)
```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  wish_id BIGINT,  -- å…³è”çš„æ„¿æœ› ID
  amount INT NOT NULL,  -- é‡‘é¢ï¼ˆåˆ†ï¼‰
  status TINYINT DEFAULT 0,  -- 0:å¾…æ”¯ä»˜ 1:å·²æ”¯ä»˜ 2:å·²å®Œæˆ 3:å·²é€€æ¬¾
  payment_id VARCHAR(64) UNIQUE,  -- å¾®ä¿¡æ”¯ä»˜è®¢å•å·ï¼ˆå”¯ä¸€ï¼Œé˜²é‡å¤ï¼‰
  out_trade_no VARCHAR(64) UNIQUE NOT NULL,  -- å•†æˆ·è®¢å•å·ï¼ˆå”¯ä¸€ï¼‰
  transaction_id VARCHAR(64),  -- å¾®ä¿¡æ”¯ä»˜äº¤æ˜“å·
  callback_received BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦å·²æ”¶åˆ°å›è°ƒ
  callback_count INT DEFAULT 0,  -- å›è°ƒæ¬¡æ•°ï¼ˆç”¨äºå¹‚ç­‰æ§åˆ¶ï¼‰
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_payment_id (payment_id),
  INDEX idx_out_trade_no (out_trade_no)
);
```

### 4.5 ç”¨æˆ·ä¼šè¯è¡¨ (user_sessions)
```sql
CREATE TABLE user_sessions (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  openid VARCHAR(64) NOT NULL,
  access_token VARCHAR(128) UNIQUE NOT NULL,  -- JWT æˆ–æœåŠ¡ç«¯ session token
  refresh_token VARCHAR(128) UNIQUE,  -- åˆ·æ–° tokenï¼ˆå¯é€‰ï¼‰
  expires_at TIMESTAMP NOT NULL,  -- token è¿‡æœŸæ—¶é—´
  device_fingerprint VARCHAR(128),  -- è®¾å¤‡æŒ‡çº¹ï¼ˆç”¨äºé£æ§ï¼‰
  last_active_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_access_token (access_token),
  INDEX idx_openid (openid)
);
```

---

## 5. å®‰å…¨æªæ–½

### 5.1 API Key ç®¡ç†
- ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¤§æ¨¡å‹ API Keyï¼ˆå¦‚ DeepSeek / Moonshotï¼‰
- æ¨èç¯å¢ƒå˜é‡ï¼š
  - `LLM_PROVIDER=moonshot|deepseek|auto`
  - `MOONSHOT_API_KEY` / `MOONSHOT_API_URL` / `MOONSHOT_MODEL`
  - `DEEPSEEK_API_KEY` / `DEEPSEEK_API_URL` / `DEEPSEEK_MODEL`
- å¯é€‰ï¼š`LLM_RETURN_FULL_RESULT_IN_ANALYZE=true|false`ï¼ˆæ˜¯å¦åœ¨ analyze å›åŒ…è¿”å›å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆç”¨äºå‰ç«¯ç¼“å­˜ï¼›å±•ç¤ºä»éœ€è§£é”ï¼‰
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚é˜¿é‡Œäº‘ KMSã€è…¾è®¯äº‘å¯†é’¥ç®¡ç†ï¼‰
- å®šæœŸè½®æ¢ API Key

### 5.2 å†…å®¹å®‰å…¨
- **âš ï¸ é‡è¦**ï¼šå‰ç«¯æ ¡éªŒåªæ˜¯ UX ä¼˜åŒ–ï¼Œä¸èƒ½ä½œä¸ºå®‰å…¨æªæ–½
- **çœŸæ­£å®‰å…¨åœ¨åç«¯**ï¼š
  - **ç”¨æˆ·è¾“å…¥å®‰å…¨**ï¼š
    - è°ƒç”¨å¾®ä¿¡å†…å®¹å®‰å…¨ APIï¼ˆ`msgSecCheck`ï¼‰
    - è‡ªå®šä¹‰è§„åˆ™è¿‡æ»¤ï¼ˆå…³é”®è¯ã€æ•æ„Ÿè¯åº“ï¼‰
    - é˜²æ­¢æç¤ºè¯æ³¨å…¥ï¼ˆè¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ã€é™åˆ¶é•¿åº¦ï¼‰
  - **æ¨¡å‹è¾“å‡ºå®‰å…¨**ï¼š
    - å¯¹ DeepSeek è¿”å›çš„å†…å®¹ä¹Ÿè¦åšå®‰å…¨å®¡æ ¸
    - è¿‡æ»¤ä¸å½“å»ºè®®ã€è¿æ³•å†…å®¹
    - ç¡®ä¿è¾“å‡ºç¬¦åˆåˆè§„è¦æ±‚
  - **å®¡æ ¸å…œåº•**ï¼š
    - é«˜é£é™©å†…å®¹äººå·¥å®¡æ ¸ï¼ˆå¯é€‰ï¼‰
    - è®°å½•å®¡æ ¸æ—¥å¿—ï¼Œä¾¿äºè¿½æº¯

### 5.3 é™æµç­–ç•¥
- **ç”¨æˆ·çº§åˆ«**ï¼šæ¯ä¸ªç”¨æˆ·æ¯å¤©æœ€å¤šè°ƒç”¨ N æ¬¡åˆ†ææ¥å£
- **IP çº§åˆ«**ï¼šé˜²æ­¢æ¶æ„åˆ·æ¥å£
- **å…¨å±€çº§åˆ«**ï¼šä¿æŠ¤ DeepSeek API ä¸è¢«è¿‡åº¦è°ƒç”¨

### 5.4 æ•°æ®åŠ å¯†
- æ•æ„Ÿæ•°æ®ï¼ˆæ„¿æœ›å†…å®¹ï¼‰åŠ å¯†å­˜å‚¨
- HTTPS ä¼ è¾“
- æ•°æ®åº“è¿æ¥ä½¿ç”¨ SSL

---

## 6. å…³é”®è®¾è®¡ç»†èŠ‚ï¼ˆè½åœ°å¿…çœ‹ï¼‰

### 6.1 ç™»å½•æ€è®¾è®¡

#### æµç¨‹
1. **å‰ç«¯**ï¼šè°ƒç”¨ `wx.login()` è·å– `code`
2. **å‰ç«¯**ï¼šå°† `code` å‘é€åˆ°åç«¯ `/api/auth/login`
3. **åç«¯**ï¼š
   - ä½¿ç”¨ `code` è°ƒç”¨å¾®ä¿¡ `code2session` æ¥å£ï¼Œè·å– `openid` å’Œ `session_key`
   - æ ¹æ® `openid` æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·è®°å½•
   - ç”Ÿæˆè‡ªå·±çš„ `access_token`ï¼ˆJWT æˆ–æœåŠ¡ç«¯ sessionï¼‰
   - å¯é€‰ï¼šç”Ÿæˆ `refresh_token` ç”¨äºç»­æœŸ
4. **åç«¯**ï¼šè¿”å› `access_token`ã€`refresh_token`ã€ç”¨æˆ·ä¿¡æ¯
5. **å‰ç«¯**ï¼šå­˜å‚¨ `access_token`ï¼Œåç»­è¯·æ±‚åœ¨ Header ä¸­æºå¸¦

#### Token è®¾è®¡
- **access_token**ï¼š
  - ç±»å‹ï¼šJWT æˆ–æœåŠ¡ç«¯ session ID
  - è¿‡æœŸæ—¶é—´ï¼š2 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
  - åŒ…å«ä¿¡æ¯ï¼š`user_id`ã€`openid`ã€`expires_at`
- **refresh_token**ï¼ˆå¯é€‰ï¼‰ï¼š
  - è¿‡æœŸæ—¶é—´ï¼š7 å¤©
  - ç”¨äºåˆ·æ–° `access_token`
- **ç»­æœŸç­–ç•¥**ï¼š
  - å®¢æˆ·ç«¯åœ¨ token å¿«è¿‡æœŸæ—¶è°ƒç”¨ `/api/auth/refresh`
  - æœåŠ¡ç«¯éªŒè¯ `refresh_token` åç­¾å‘æ–°çš„ `access_token`
- **è¸¢ä¸‹çº¿ç­–ç•¥**ï¼š
  - æœåŠ¡ç«¯ç»´æŠ¤ç”¨æˆ·æ´»è·ƒ session åˆ—è¡¨
  - åŒä¸€ç”¨æˆ·æœ€å¤šå…è®¸ N ä¸ªæ´»è·ƒ sessionï¼ˆå¦‚ 3 ä¸ªï¼‰
  - æ–°ç™»å½•æ—¶ï¼Œè¸¢æ‰æœ€æ—§çš„ session

### 6.2 è§£é” Token è®¾è®¡

#### ç”Ÿæˆè§„åˆ™
- **ç»‘å®šå…³ç³»**ï¼š`unlock_token` å¿…é¡»ç»‘å®š `user_id` + `analysis_id`
- **æ ¼å¼**ï¼š`{user_id}:{analysis_id}:{timestamp}:{signature}`
- **è¿‡æœŸæ—¶é—´**ï¼š5 åˆ†é’Ÿï¼ˆçŸ­è¿‡æœŸï¼Œé™ä½è¢«è½¬å‘é£é™©ï¼‰
- **ä¸€æ¬¡æ€§ä½¿ç”¨**ï¼šä½¿ç”¨åç«‹å³æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼ˆ`unlock_token_used = true`ï¼‰

#### é˜²é‡æ”¾æœºåˆ¶
```sql
-- è§£é”æ—¶æ£€æŸ¥
SELECT * FROM analyses 
WHERE unlock_token = ? 
  AND user_id = ? 
  AND unlock_token_expires_at > NOW()
  AND unlock_token_used = FALSE
FOR UPDATE;  -- è¡Œé”ï¼Œé˜²æ­¢å¹¶å‘

-- ä½¿ç”¨åç«‹å³æ ‡è®°
UPDATE analyses 
SET unlock_token_used = TRUE 
WHERE id = ?;
```

#### å¹‚ç­‰æ€§
- åŒä¸€ `unlock_token` å¤šæ¬¡è°ƒç”¨è¿”å›ç›¸åŒç»“æœ
- å·²ä½¿ç”¨çš„ token è¿”å›é”™è¯¯ï¼Œä¸é‡å¤å‘æ”¾æƒç›Š

### 6.3 å¹¿å‘Š/åˆ†äº«è§£é”é£æ§ç­–ç•¥

#### âš ï¸ é‡è¦è®¤çŸ¥
- **æ— æ³•åšåˆ°å¼ºéªŒè¯**ï¼šå¾®ä¿¡æ¿€åŠ±è§†é¢‘å¹¿å‘Šå’Œåˆ†äº«è¡Œä¸ºæ²¡æœ‰å¯é çš„æœåŠ¡ç«¯éªŒè¯ API
- **å®šä½ä¸ºé£æ§æ¦‚ç‡æ­£ç¡®**ï¼šé€šè¿‡å¤šç»´åº¦é£æ§é™ä½åˆ·è§£é”æ¦‚ç‡

#### é£æ§ç»´åº¦
1. **è®¾å¤‡æŒ‡çº¹**ï¼š
   - æ”¶é›†è®¾å¤‡ä¿¡æ¯ï¼ˆè®¾å¤‡ IDã€ç³»ç»Ÿç‰ˆæœ¬ã€å±å¹•å°ºå¯¸ç­‰ï¼‰
   - ç”Ÿæˆè®¾å¤‡æŒ‡çº¹ï¼Œè¯†åˆ«å¼‚å¸¸è®¾å¤‡
   - åŒä¸€è®¾å¤‡çŸ­æ—¶é—´å†…å¤šæ¬¡è§£é” â†’ é£é™©æ ‡è®°

2. **è¡Œä¸ºåºåˆ—**ï¼š
   - è®°å½•ç”¨æˆ·æ“ä½œæµç¨‹ï¼šæ‰“å¼€ â†’ è¾“å…¥ â†’ åˆ†æ â†’ è§£é”
   - å¼‚å¸¸è¡Œä¸ºï¼ˆç›´æ¥è°ƒç”¨è§£é”æ¥å£ï¼‰â†’ é£é™©æ ‡è®°
   - æ­£å¸¸æµç¨‹æ—¶é—´é—´éš”è¿‡çŸ­ â†’ é£é™©æ ‡è®°

3. **é¢‘æ§**ï¼š
   - åŒä¸€ç”¨æˆ·/è®¾å¤‡ï¼šæ¯å°æ—¶æœ€å¤šè§£é” N æ¬¡ï¼ˆå¦‚ 5 æ¬¡ï¼‰
   - åŒä¸€ IPï¼šæ¯å°æ—¶æœ€å¤šè§£é” M æ¬¡ï¼ˆå¦‚ 20 æ¬¡ï¼‰
   - è¶…è¿‡é¢‘æ§ â†’ æ‹’ç»æˆ–è¦æ±‚é¢å¤–éªŒè¯

4. **é»‘åå•**ï¼š
   - è®°å½•å¼‚å¸¸è®¾å¤‡ã€IPã€ç”¨æˆ·
   - é»‘åå•ç”¨æˆ·ç›´æ¥æ‹’ç»è§£é”

5. **å¼±ä¿¡å·éªŒè¯**ï¼ˆå¯é€‰ï¼‰ï¼š
   - å¹¿å‘Šè§£é”ï¼šè®°å½•å¹¿å‘Šæ’­æ”¾æ—¶é•¿ã€å®Œæˆåº¦ï¼ˆå‰ç«¯ä¸ŠæŠ¥ï¼‰
   - åˆ†äº«è§£é”ï¼šè®°å½•åˆ†äº«ç›®æ ‡ã€åˆ†äº«æ—¶é—´ï¼ˆå‰ç«¯ä¸ŠæŠ¥ï¼‰
   - è¿™äº›ä¿¡å·åªèƒ½ä½œä¸ºå‚è€ƒï¼Œä¸èƒ½ä½œä¸ºå”¯ä¸€ä¾æ®

### 6.4 æ”¯ä»˜å›è°ƒå¹‚ç­‰ä¸éªŒç­¾

#### âš ï¸ å¿…é¡»å®ç°
å¾®ä¿¡æ”¯ä»˜å›è°ƒå¯èƒ½å‡ºç°ï¼š
- å¤šæ¬¡å›è°ƒï¼ˆç½‘ç»œé‡è¯•ï¼‰
- ä¹±åºå›è°ƒï¼ˆåå‘çš„å›è°ƒå…ˆåˆ°è¾¾ï¼‰
- æ¶æ„ä¼ªé€ å›è°ƒ

#### å¤„ç†æµç¨‹
1. **éªŒç­¾**ï¼š
   ```javascript
   // ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜æä¾›çš„ç­¾åç®—æ³•éªŒè¯å›è°ƒç­¾å
   const sign = calculateSign(callbackData, wxpayKey);
   if (sign !== callbackData.sign) {
     return { code: -1, msg: 'ç­¾åéªŒè¯å¤±è´¥' };
   }
   ```

2. **å»é‡**ï¼š
   ```sql
   -- ä½¿ç”¨ transaction_id æˆ– out_trade_no ä½œä¸ºå”¯ä¸€æ ‡è¯†
   SELECT * FROM orders 
   WHERE transaction_id = ? 
     AND callback_received = TRUE;
   
   -- å¦‚æœå·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸï¼ˆå¹‚ç­‰ï¼‰
   ```

3. **çŠ¶æ€æœºæ¨è¿›**ï¼š
   ```javascript
   // è®¢å•çŠ¶æ€æµè½¬ï¼šå¾…æ”¯ä»˜(0) â†’ å·²æ”¯ä»˜(1) â†’ å·²å®Œæˆ(2)
   // åªå…è®¸å‘å‰æ¨è¿›ï¼Œä¸å…è®¸å›é€€
   if (currentStatus >= targetStatus) {
     return { code: 0, msg: 'çŠ¶æ€å·²æ›´æ–°ï¼Œæ— éœ€é‡å¤å¤„ç†' };
   }
   
   // ä½¿ç”¨äº‹åŠ¡ + è¡Œé”æ›´æ–°
   BEGIN TRANSACTION;
   UPDATE orders 
   SET status = ?, 
       callback_received = TRUE,
       callback_count = callback_count + 1
   WHERE id = ? 
     AND status < ?  -- åªå…è®¸å‘å‰æ¨è¿›
   FOR UPDATE;
   COMMIT;
   ```

4. **è®°å½•å›è°ƒæ—¥å¿—**ï¼š
   - è®°å½•æ¯æ¬¡å›è°ƒçš„åŸå§‹æ•°æ®ã€å¤„ç†ç»“æœ
   - ä¾¿äºæ’æŸ¥é—®é¢˜å’Œå®¡è®¡

---

## 7. æˆæœ¬ä¼°ç®—ï¼ˆå‚è€ƒï¼‰

### 6.1 DeepSeek API æˆæœ¬
- **è¾“å…¥ Token**ï¼šçº¦ Â¥0.0014 / 1K tokens
- **è¾“å‡º Token**ï¼šçº¦ Â¥0.0056 / 1K tokens
- **å•æ¬¡åˆ†æé¢„ä¼°**ï¼šè¾“å…¥ 500 tokens + è¾“å‡º 1000 tokens â‰ˆ Â¥0.006
- **1000 æ¬¡åˆ†æ**ï¼šçº¦ Â¥6

### 7.2 æœåŠ¡å™¨æˆæœ¬
- **è½»é‡çº§åç«¯**ï¼š2æ ¸2G äº‘æœåŠ¡å™¨ â‰ˆ Â¥50-100/æœˆ
- **æ•°æ®åº“**ï¼šäº‘æ•°æ®åº“ RDSï¼ˆåŸºç¡€ç‰ˆï¼‰â‰ˆ Â¥100-200/æœˆ
- **Serverless æ–¹æ¡ˆ**ï¼šæŒ‰é‡ä»˜è´¹ï¼ŒåˆæœŸæˆæœ¬æ›´ä½

---

## 8. MVP æœ€å°åŒ–åç«¯æ–¹æ¡ˆ

å¦‚æœé¢„ç®—æœ‰é™ï¼Œå¯ä»¥è€ƒè™‘ï¼š

### æ–¹æ¡ˆ Aï¼šServerlessï¼ˆæ¨è MVPï¼‰
- **åç«¯**ï¼šå¾®ä¿¡äº‘å¼€å‘ æˆ– é˜¿é‡Œäº‘å‡½æ•°è®¡ç®—
- **æ•°æ®åº“**ï¼šå¾®ä¿¡äº‘æ•°æ®åº“ æˆ– äº‘æ•°æ®åº“ï¼ˆæŒ‰é‡ä»˜è´¹ï¼‰
- **ä¼˜åŠ¿**ï¼šæ— éœ€ç»´æŠ¤æœåŠ¡å™¨ï¼ŒæŒ‰é‡ä»˜è´¹ï¼Œæˆæœ¬ä½
- **åŠ£åŠ¿**ï¼šå†·å¯åŠ¨å¯èƒ½å½±å“å“åº”é€Ÿåº¦

### æ–¹æ¡ˆ Bï¼šè½»é‡çº§æœåŠ¡å™¨
- **åç«¯**ï¼š1æ ¸1G äº‘æœåŠ¡å™¨ + Node.js
- **æ•°æ®åº“**ï¼šSQLiteï¼ˆåˆæœŸï¼‰æˆ– MySQLï¼ˆäº‘æ•°æ®åº“ï¼‰
- **ä¼˜åŠ¿**ï¼šå®Œå…¨æ§åˆ¶ï¼Œå“åº”å¿«
- **åŠ£åŠ¿**ï¼šéœ€è¦è¿ç»´ï¼Œæˆæœ¬ç¨é«˜

---

## 9. å¼€å‘ä¼˜å…ˆçº§

### Phase 1ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆMVPï¼‰
1. âœ… ç”¨æˆ·ç™»å½•ï¼ˆå¾®ä¿¡æˆæƒï¼‰
2. âœ… æ„¿æœ›åˆ†ææ¥å£ï¼ˆè°ƒç”¨ DeepSeekï¼‰
3. âœ… TODO åˆ—è¡¨ CRUD
4. âœ… åŸºç¡€å†…å®¹å®‰å…¨è¿‡æ»¤

### Phase 2ï¼šè§£é”åŠŸèƒ½
1. âœ… è§£é” token ç”Ÿæˆä¸éªŒè¯ï¼ˆç»‘å®š user_id + analysis_idï¼‰
2. âœ… å¹¿å‘Šè§£é”é£æ§ï¼ˆè®¾å¤‡æŒ‡çº¹ + è¡Œä¸ºåºåˆ— + é¢‘æ§ï¼‰
3. âœ… åˆ†äº«è§£é”é£æ§ï¼ˆåŒä¸Šï¼‰
4. âœ… è§£é”çŠ¶æ€ç®¡ç†ï¼ˆRedis + æ•°æ®åº“ï¼‰

### Phase 3ï¼šæ”¯ä»˜åŠŸèƒ½
1. âœ… å¾®ä¿¡æ”¯ä»˜é›†æˆ
2. âœ… è®¢å•ç®¡ç†
3. âœ… æ”¯ä»˜å›è°ƒå¤„ç†ï¼ˆéªŒç­¾ + å»é‡ + çŠ¶æ€æœºæ¨è¿›ï¼‰

### Phase 4ï¼šä¼˜åŒ–
1. â³ ç¼“å­˜ä¼˜åŒ–
2. â³ é™æµå®Œå–„
3. â³ æ•°æ®åˆ†æ
4. â³ æ€§èƒ½ä¼˜åŒ–

---

## æ€»ç»“

**å¿…é¡»å‰åç«¯åˆ†ç¦»çš„åŸå› **ï¼š
1. ğŸ”’ API Key å®‰å…¨
2. ğŸ›¡ï¸ å†…å®¹å®‰å…¨å®¡æ ¸
3. ğŸ’° æˆæœ¬æ§åˆ¶ä¸é™æµ
4. ğŸ’¾ æ•°æ®æŒä¹…åŒ–å­˜å‚¨

**æ¨èæ¶æ„**ï¼š
- å‰ç«¯ï¼šå¾®ä¿¡å°ç¨‹åºï¼ˆTaro æˆ–åŸç”Ÿï¼‰
- åç«¯ï¼šNode.js/Python + MySQL + Redis
- éƒ¨ç½²ï¼šäº‘æœåŠ¡å™¨ æˆ– Serverlessï¼ˆMVP æ¨èï¼‰

**MVP æœ€å°åŒ–æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Serverless + äº‘æ•°æ®åº“ï¼Œå¿«é€Ÿä¸Šçº¿éªŒè¯ã€‚
