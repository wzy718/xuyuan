# 小约定App - 数据存储与同步机制

## 一、离线同步冲突处理机制

### 冲突检测策略

#### 版本向量时钟
- 每个约定维护设备级版本号
- 格式：`{deviceId: version, timestamp: time}`
- 每次修改版本号递增
- 支持多设备并发修改检测

#### 操作日志队列
- 离线期间所有操作按时间戳记录
- 操作类型：CREATE, UPDATE, DELETE, STATE_CHANGE
- 队列持久化到本地数据库
- 联网后按序同步

#### 数据指纹对比
- 使用MD5快速检测内容变化
- 对比本地与服务器数据指纹
- 不同则触发冲突解决流程

#### 冲突类型识别
- **字段级冲突**：同一字段不同值
- **结构性冲突**：约定状态不一致
- **删除冲突**：一方删除一方修改
- **创建冲突**：重复创建相同约定

### 冲突解决规则

#### 自动合并策略

##### 时间戳优先（Last Write Wins）
- 适用于：备注、提醒时间等非关键字段
- 规则：最后修改时间的版本胜出
- 记录：保留冲突历史供查看

##### 字段级合并
- 不同字段的修改自动合并
- 示例：A改标题，B改时间，两者都保留
- 前提：字段间无依赖关系

##### 累加型数据
- 打卡次数：取最大值
- 证据数量：合并去重
- 参与人数：并集处理

#### 需人工确认场景

##### 核心内容修改
- 约定金额变更
- 执行时间调整
- 执行标准修改
- 需求：弹窗展示差异，用户选择

##### 参与方变更
- 添加/删除见证人
- 参与者角色调整
- 权限变更
- 处理：需所有参与方确认

##### 状态回退
- 从完成改为进行中
- 从失败改为成功
- 异常状态转换
- 方案：管理员介入或投票决定

#### 冲突提示界面

##### 对比展示
```
┌────────────────────────────┐
│     冲突解决 - 选择版本      │
├────────────────────────────┤
│  本地版本        云端版本    │
│  ─────────      ─────────   │
│  截止：明天      截止：后天   │
│  修改：10:30    修改：10:35  │
├────────────────────────────┤
│ [使用本地] [使用云端] [合并] │
└────────────────────────────┘
```

##### 智能建议
- 基于用户历史选择偏好
- 分析修改重要性
- 推荐最可能的选项

### 同步队列管理

#### 优先级排序

| 优先级 | 类型 | 说明 |
|--------|------|------|
| P0 | 正在进行的约定 | 实时性要求高 |
| P1 | 今日到期约定 | 时效性重要 |
| P2 | 见证人相关操作 | 影响他人 |
| P3 | 历史数据同步 | 可延迟 |

#### 批量同步优化

##### 增量同步
- 只传输变更字段
- 使用diff算法计算差异
- 减少数据传输量

##### 压缩传输
- Gzip压缩大批量数据
- 图片自动压缩（保持质量）
- 分片上传大文件

##### 断点续传
- 大文件分块上传
- 记录已传输块
- 失败自动重试未完成块

#### 同步状态可视化

##### 实时进度展示
```
正在同步约定数据...
████████░░ 80% (8/10)
预计剩余时间：5秒
```

##### 失败项处理
- 单独标记失败项
- 显示失败原因
- 提供重试按钮

### 本地缓存策略

#### 存储方案
- **SQLite**：存储结构化数据（约定、用户、关系）
- **SharedPreferences**：存储配置（设置、偏好）
- **文件系统**：存储证据文件（图片、音频）
- **内存缓存**：高频访问数据

#### 缓存管理
- **LRU淘汰**：最近最少使用淘汰
- **大小限制**：最大500MB
- **过期清理**：30天未访问自动清理
- **手动清理**：提供清理缓存选项

## 二、数据模型设计

### 约定数据结构

```json
{
  "id": "uuid",
  "version": 1,
  "device_version": {
    "device_001": 3,
    "device_002": 2
  },
  "title": "每日运动30分钟",
  "type": "self_discipline",
  "status": "active",
  "participants": [...],
  "witnesses": [...],
  "created_at": "2024-01-01T10:00:00Z",
  "updated_at": "2024-01-01T10:00:00Z",
  "sync_status": "synced",
  "local_changes": []
}
```

### 操作日志结构

```json
{
  "id": "log_uuid",
  "commitment_id": "uuid",
  "operation": "UPDATE",
  "field": "status",
  "old_value": "active",
  "new_value": "paused",
  "device_id": "device_001",
  "timestamp": "2024-01-01T10:00:00Z",
  "synced": false
}
```

## 三、同步流程设计

### 启动同步

```mermaid
1. 检查网络状态
2. 获取本地未同步数据
3. 构建同步队列（按优先级）
4. 开始批量同步
```

### 同步过程

```mermaid
1. 发送本地版本信息
2. 服务器返回冲突列表
3. 自动解决简单冲突
4. 提示用户解决复杂冲突
5. 上传本地修改
6. 下载服务器更新
7. 更新本地数据库
```

### 完成处理

```mermaid
1. 标记同步完成
2. 清理操作日志
3. 更新UI状态
4. 发送同步报告
```

## 四、异常处理

### 网络异常
- **处理**：自动重试（指数退避）
- **限制**：最多重试5次
- **降级**：转为离线模式

### 数据异常
- **校验**：数据完整性检查
- **修复**：自动修复或提示用户
- **回滚**：严重错误回滚到稳定版本

### 存储异常
- **监控**：剩余空间监控
- **清理**：自动清理过期数据
- **提示**：存储不足提醒用户

## 五、性能优化

### 同步优化
- 后台静默同步
- WiFi环境自动同步
- 电量充足时批量同步

### 数据优化
- 数据分页加载
- 图片懒加载
- 预加载常用数据

### 电量优化
- 低电量暂停同步
- 使用JobScheduler优化
- 合并网络请求

## 六、安全措施

### 数据加密
- 传输加密：HTTPS/TLS
- 存储加密：SQLCipher
- 敏感字段：AES加密

### 身份验证
- Token认证机制
- 设备指纹绑定
- 异常登录检测

### 隐私保护
- 本地数据隔离
- 最小权限原则
- 数据脱敏处理

## 七、监控与统计

### 同步监控
- 同步成功率
- 平均同步时长
- 冲突发生率

### 性能监控
- 数据库查询耗时
- 网络请求延迟
- 内存使用情况

### 用户行为
- 离线使用时长
- 同步频率分析
- 冲突解决选择

## 八、未来优化方向

### 技术升级
- WebSocket实时同步
- 差分同步算法
- 边缘计算节点

### 功能增强
- 多设备协同编辑
- 版本历史回溯
- 智能冲突预测