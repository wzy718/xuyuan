# 小约定App - 约定状态管理系统

## 一、状态定义与流转规则

### 1. 草稿状态 (Draft)

#### 进入条件
- 用户创建约定未发送
- 被拒绝的约定返回修改

#### 允许操作
- 自由编辑所有字段
- 保存为模板
- 删除无需确认
- 邀请参与者（发送后转为待确认）

#### 退出路径
- 发送邀请 → 待确认状态
- 直接删除 → 已删除状态

#### 数据特征
- 仅本地存储，不同步云端
- 自动保存编辑内容
- 支持多个草稿并存

### 2. 待确认状态 (Pending)

#### 进入条件
- 发起者发送邀请
- 草稿状态点击发送

#### 允许操作
- **发起者**：
  - 撤回邀请（24小时内）
  - 补充说明信息
  - 查看确认进度
- **参与者**：
  - 接受邀请
  - 拒绝邀请
  - 请求修改内容
- **见证人**：
  - 接受见证邀请
  - 拒绝见证邀请

#### 退出路径
- 全员确认 → 进行中状态
- 任一拒绝 → 草稿状态（需重新编辑）
- 超时未响应（72小时）→ 已失效状态

#### 通知机制
- 发送邀请立即通知
- 每12小时提醒未确认方
- 最后6小时紧急提醒

### 3. 进行中状态 (Active)

#### 进入条件
- 所有参与方确认
- 暂停状态恢复执行

#### 允许操作
- 执行打卡/上传证据
- 申请修改（需全员同意）
- 申请暂停（单方面，最多3次）
- 申请延期（需见证人同意）
- 紧急终止（需说明原因）

#### 修改规则

##### 可自由修改项（实时生效）
- 提醒时间
- 通知方式
- 证据格式要求
- 备注信息

##### 需对方确认项（48小时响应期）
- 执行标准调整
- 截止时间延期（最多延期2次）
- 见证人变更
- 执行频率调整

##### 不可修改项
- 约定核心内容
- 参与者身份
- 奖惩机制（如有）
- 约定类型

#### 退出路径
- 正常完成 → 已完成状态
- 到期未完成 → 已失败状态
- 协商终止 → 已终止状态
- 申请暂停 → 暂停状态

### 4. 暂停状态 (Paused)

#### 进入条件
- 任一方申请且说明原因
- 系统检测异常自动暂停

#### 暂停规则
- 单次最长7天
- 累计不超过21天
- 每个约定最多暂停3次
- 暂停期间不计入执行时间

#### 允许操作
- **申请方**：
  - 恢复执行
  - 申请终止
  - 延长暂停（需对方同意）
- **其他方**：
  - 查看暂停原因
  - 发起沟通
  - 同意/拒绝延长

#### 自动恢复机制
- 到期自动转为进行中
- 提前24小时提醒即将恢复
- 恢复后重新计算截止时间

#### 退出路径
- 手动恢复 → 进行中状态
- 超期未恢复 → 已失败状态
- 协商终止 → 已终止状态

### 5. 已完成状态 (Completed)

#### 进入条件
- 所有执行项完成
- 见证人确认（如有）
- 到达截止时间且判定成功

#### 完成后操作
- 生成完成证书
- 计入信用记录
- 可分享成就
- 归档但可查看
- 发送感谢卡片

#### 数据展示
- 完成时间记录
- 执行情况统计
- 证据材料存档
- 见证人评价

#### 不可逆规则
- 无法修改记录
- 无法重新激活
- 可以复制创建新约定

### 6. 已失败状态 (Failed)

#### 进入条件
- 到期未完成目标
- 主动放弃
- 严重违约
- 暂停超期

#### 失败后处理
- 记录失败原因
- 影响信用分（如有）
- 可发起复盘讨论
- 可创建改进版约定

#### 申诉机制
- 7天内可申请重新评估
- 提供补充证据
- 见证人重新确认
- 最多申诉1次

### 7. 已终止状态 (Terminated)

#### 进入条件
- 双方协商一致
- 不可抗力因素
- 系统判定无法继续

#### 终止类型
- **友好终止**：不影响信用
- **争议终止**：需要仲裁
- **系统终止**：违规内容

#### 数据处理
- 保留记录但不计入统计
- 标记终止原因
- 不影响历史数据

## 二、撤销与删除机制

### 撤销规则

#### 草稿/待确认状态
- 发起者可自由撤销
- 无需其他人同意
- 不影响信用分

#### 进行中状态
- **24小时内**：发起者可单方面撤销
- **24小时后**：需全员同意（3天响应期）
- **见证人否决权**：可阻止恶意撤销

#### 撤销后果
- 信用分扣减（恶意撤销）
- 撤销次数限制（月度5次）
- 撤销原因强制填写并公示

### 删除权限

#### 硬删除
- 仅草稿状态支持
- 立即从数据库移除
- 无法恢复

#### 软删除
- 其他状态仅标记删除
- 用户不可见但数据保留
- 管理员可查看

#### 数据保留策略
- 删除后保留30天用于恢复
- 30天后自动清理
- 重要数据永久存档

#### 隐私删除
- 用户注销时的批量处理
- 遵循GDPR等隐私法规
- 提供数据导出选项

## 三、版本管理机制

### 版本记录

#### 记录内容
- 每次修改生成新版本
- 保留最近10个版本
- 记录修改人、时间、内容对比

#### 版本对比
- 高亮显示差异
- 支持任意版本对比
- 导出版本历史

### 版本回滚

#### 回滚条件
- 争议时可查看历史版本
- 全员同意可回滚到指定版本
- 回滚操作记入日志

#### 回滚限制
- 仅支持最近7天内版本
- 每个约定最多回滚3次
- 已完成状态不可回滚

### 变更通知

#### 通知机制
- 实时推送给所有参与者
- 高亮显示变更内容
- 要求确认已知晓

#### 通知内容
- 变更项目明细
- 变更原因说明
- 变更时间记录
- 操作人信息

## 四、状态流转图

```
草稿 ──发送──> 待确认 ──确认──> 进行中
 ↓              ↓              ↓ ↓ ↓
删除          已失效      暂停 完成 失败
                          ↓
                        已终止
```

## 五、异常处理

### 超时处理
- 待确认超72小时 → 自动失效
- 暂停超期 → 自动失败
- 延期申请超时 → 自动拒绝

### 冲突处理
- 同时修改冲突 → 后者覆盖
- 状态冲突 → 以服务器为准
- 版本冲突 → 提示手动解决

### 数据恢复
- 意外删除30天内可恢复
- 系统故障自动回滚
- 定期备份关键数据