# 小约定App - 端侧AI集成方案（核心必备功能）

## 一、AI模型选型

### 模型选择：阿里通义千问 Qwen3-0.6B

#### 选择理由
- **超轻量级**：0.6B参数（实际非嵌入参数0.44B），专为边缘设备设计
- **中文原生**：支持100+语言，中文理解能力业界领先
- **思维模式**：独特的thinking/non-thinking双模式切换
- **开源免费**：Apache 2.0协议，商用友好无限制
- **长上下文**：支持32,768 tokens上下文长度

#### 模型架构
- **参数量**：0.6B（600M参数）
- **模型层数**：28层
- **注意力头**：16个Query头，8个Key-Value头（GQA架构）
- **词表大小**：151,665
- **隐藏层维度**：896
- **中间层维度**：4,864

#### 模型文件规格
| 格式 | 文件大小 | 内存需求 | 推荐场景 |
|------|----------|----------|----------|
| FP16原始 | 1.5GB | 2.5GB | 高端设备 |
| INT8量化 | ~750MB | 1.5GB | 中端设备 |
| INT4量化 | ~380MB | 1GB | 低端设备 |
| GGUF Q4_K_M | ~450MB | 1.2GB | **推荐配置** |

**推荐部署方案**：GGUF Q4_K_M量化格式，平衡模型大小与推理性能

## 二、模型部署策略

### 部署原则
**端侧AI是核心增值功能，用户可选择是否启用**

### 部署流程设计

#### 首次启动流程
1. 检测本地是否存在模型文件
2. 向用户展示AI功能介绍界面
3. 用户选择：
   - 同意启用 → 进入下载流程
   - 稍后决定 → 使用基础模式
4. 下载模型（多CDN智能选择）
5. 文件完整性校验（SHA256）
6. 模型加载与预热测试
7. AI功能就绪

#### AI功能介绍界面内容
- AI助手核心能力展示
  - 智能理解口语化描述
  - 自动生成结构化约定
  - 个性化推荐模板
  - 优化约定内容表达
- 存储空间需求说明（450MB）
- 隐私保护承诺（本地运行，离线可用）
- 用户选择按钮：立即启用 / 稍后再说 / 了解更多

#### 下载确认界面设计
- 文件大小提醒（450MB）
- 网络环境建议（WiFi优先）
- 价值点强调：
  - 完全离线的AI功能
  - 隐私数据不上传云端
  - 更智能的约定创建体验
- 流量使用选项（允许移动数据）
- 操作按钮：开始下载 / 取消

#### 下载进度管理
- 实时进度展示（百分比+已下载/总大小）
- 下载速度显示
- 预计剩余时间
- 后台下载选项
- 取消下载功能

### 模型文件管理策略

#### 存储位置规划
- 应用私有目录存储
- 模型文件结构：
  - 主模型文件（GGUF格式）
  - 分词器配置
  - 模型配置文件
  - 版本信息记录

#### 完整性保障
- SHA256哈希值校验
- 文件大小验证
- 版本兼容性检查
- 损坏自动重下载

#### 更新机制
- 应用更新时检查模型版本
- 后台静默下载新版本
- 下次启动时平滑切换
- 保留旧版本直到新版验证成功

## 三、移动端集成架构

### Flutter集成方案

#### 技术选型
1. **跨平台方案**：llama.cpp + Flutter FFI
   - 优势：统一代码库，维护成本低
   - 支持：iOS、Android双平台

2. **iOS原生优化**：MLX框架（Apple官方）
   - 优势：Metal加速，性能最优
   - 特点：支持Apple Silicon优化

3. **Android原生优化**：MNN框架（阿里官方）
   - 优势：深度优化Qwen模型
   - 特点：支持多种硬件加速

### 集成架构设计
- Flutter层：UI界面与业务逻辑
- Bridge层：平台通道通信
- Native层：模型加载与推理
- 缓存层：推理结果缓存

## 四、性能优化策略

### 双模式推理设计

#### Thinking模式（深度思考）
- 使用场景：复杂约定创建
- 参数配置：Temperature 0.6, Top-p 0.95
- 输出特点：更准确、更结构化
- 响应时间：1-2秒

#### Normal模式（快速响应）
- 使用场景：简单内容补全
- 参数配置：Temperature 0.7, Top-p 0.8
- 输出特点：流畅自然
- 响应时间：<1秒

### 推理优化机制

#### 缓存策略
- LRU缓存最近100条推理结果
- 相似输入识别与复用
- 缓存命中率监控
- 定期清理过期缓存

#### 批处理优化
- 收集多个请求合并处理
- 最大批次：4个请求
- 最大等待：100ms
- 优先级队列管理

#### 内存管理
- 最大内存占用：500MB
- 动态内存监控
- 低内存自动降级
- 缓存自动清理

## 五、核心应用场景

### 1. AI快速创建（核心场景）

#### 一句话创建约定
- **输入方式**：自然语言/语音/图片
- **处理流程**：
  1. AI解析提取关键信息
  2. 识别缺失信息
  3. 一次性展示待补充项
  4. 智能生成里程碑和TODO
  5. 一键创建完成

#### 输入输出示例
```yaml
示例1:
  输入: "我要和女朋友一起学英语"
  AI解析:
    - 参与人: [我, 女朋友]
    - 目标: 学英语
    - 关系: 情侣
  一次性补充:
    - 学习时长: [1周, 2周, 1个月⭐, 3个月]
    - 每日时间: [30分钟⭐, 45分钟, 60分钟]
    - 学习时段: [早晨, 晚上⭐, 睡前]
    - 打卡方式: [学习笔记, 录音, 互相确认⭐]
  自动生成:
    - 里程碑: 每周掌握50个单词
    - TODO: 每日单词+口语练习

示例2:
  输入: "每天早上6点起床跑步"
  AI解析:
    - 参与人: [我]
    - 目标: 跑步
    - 时间: 每天早上6点
  一次性补充:
    - 跑步距离: [3公里, 5公里⭐, 10公里]
    - 持续时间: [1周, 1个月⭐, 3个月]
    - 打卡方式: [运动数据⭐, 自拍, 轨迹记录]
  自动生成:
    - 每周目标: 累计跑步35公里
    - 提醒: 5:30起床准备
```

### 2. 智能信息提取

#### 实体识别能力
- **人物识别**：我、女朋友、老婆、孩子、朋友、同事
- **时间识别**：今天、明天、本周、下周五、一个月内
- **频率识别**：每天、隔天、每周、工作日、周末
- **目标识别**：动词+名词组合（学英语、减重、读书）
- **数量识别**：5公斤、30分钟、100页、10公里

#### 关系类型推断
```javascript
// 关系推断逻辑
function inferRelationType(participants, content) {
  if (participants.length === 1) {
    return 'personal'; // 个人目标
  }
  
  if (hasKeywords(['女朋友', '男朋友', '老婆', '老公'])) {
    return 'couple'; // 情侣关系
  }
  
  if (hasKeywords(['孩子', '儿子', '女儿', '宝宝'])) {
    return 'parent_child'; // 亲子关系
  }
  
  if (participants.length > 2) {
    return 'group'; // 团队关系
  }
  
  return 'custom'; // 自定义关系
}
```

### 3. 智能补全策略

#### 一次性展示原则
- **不打扰**：所有待补充项一屏展示
- **预填充**：每项都有AI建议的默认值
- **可跳过**：非必填项可以忽略
- **快速完成**：一键采纳所有建议

#### 补充项智能排序
1. **必填项**（高亮显示）
   - 缺失的关键信息
   - 执行频率和时长
   
2. **建议项**（默认展开）
   - 提醒时间
   - 打卡方式
   - 里程碑设置
   
3. **可选项**（折叠状态）
   - 见证人邀请
   - 奖惩机制
   - 高级设置

### 4. 里程碑自动生成

#### 生成规则
```yaml
短期目标（1-7天）:
  - 按天拆分
  - 每日具体任务
  
中期目标（1-4周）:
  - 按周拆分
  - 每周阶段目标
  
长期目标（1-12月）:
  - 按月拆分
  - 月度里程碑

示例:
  输入: "一个月减重5公斤"
  生成:
    - 第1周: 减重1.5公斤，建立运动习惯
    - 第2周: 减重1.5公斤，优化饮食结构
    - 第3周: 减重1公斤，强化有氧运动
    - 第4周: 减重1公斤，巩固成果
```

### 5. TODO智能拆分

#### 拆分维度
- **时间维度**：每日/每周/每月任务
- **内容维度**：主任务/子任务/可选任务
- **优先级**：必做/建议/可选

#### 示例
```yaml
约定: "每天学英语30分钟"
TODO生成:
  每日必做:
    - 背诵10个新单词（10分钟）
    - 复习昨日单词（5分钟）
    - 口语练习（10分钟）
    - 听力训练（5分钟）
  
  每周建议:
    - 完成一篇阅读理解
    - 观看一集美剧
    - 参加口语角活动
  
  每月目标:
    - 掌握300个单词
    - 能进行5分钟对话
```

### 6. 手动模式AI辅助

#### 触发时机
- 用户选择手动创建
- 填写表单过程中
- 保存前的优化建议

#### 辅助方式
- **实时提示**：输入时显示相关建议
- **智能补全**：根据已填信息推断其他字段
- **优化建议**：💡图标提示可改进项
- **一键优化**：应用所有AI建议

## 六、基础模式与AI模式对比

### 功能对比

| 功能 | 基础模式 | AI模式 |
|------|---------|---------|
| 创建约定 | ✅ 手动填写表单 | ✅ 对话式创建 |
| 选择模板 | ✅ 固定模板库 | ✅ 智能推荐 |
| 约定管理 | ✅ 完整功能 | ✅ 完整功能 |
| 打卡执行 | ✅ 完整功能 | ✅ 完整功能 |
| 见证人 | ✅ 完整功能 | ✅ 完整功能 |
| 通知提醒 | ✅ 完整功能 | ✅ 完整功能 |
| 自然语言理解 | ❌ 不支持 | ✅ 支持 |
| 内容优化建议 | ❌ 不支持 | ✅ 支持 |
| 个性化推荐 | ❌ 基础推荐 | ✅ 智能推荐 |
| 冲突检测 | ❌ 不支持 | ✅ 智能检测 |

### 基础模式保障
- 完整的表单创建流程
- 丰富的固定模板库
- 基于规则的推荐
- 所有核心功能可用

### AI增值体验
- 自然语言输入
- 智能内容生成
- 个性化推荐
- 冲突预警提醒

## 七、用户引导策略

### AI功能推广时机
1. **首次启动**：新手引导中介绍
2. **创建约定时**：展示AI简化优势
3. **使用模板时**：对比智能推荐
4. **设置页面**：提供功能开关

### 价值传达方式
- 功能对比展示
- 成功案例分享
- 限时免费体验
- 用户testimonial

### 顾虑消除措施
- 强调本地运行
- 说明隐私保护
- 提供存储管理
- 支持随时关闭

## 八、错误处理机制

### 下载失败处理
- 多CDN自动切换
- 断点续传支持
- 智能重试策略
- 用户友好提示

### 加载失败处理
- 非阻塞式提醒
- 基础功能可用
- 重试下载选项
- 问题诊断指引

### 推理异常处理
- 降级到基础模式
- 缓存结果复用
- 错误日志记录
- 用户反馈通道

## 九、隐私与安全

### 数据隐私保护
- **本地推理**：所有AI计算在设备端完成
- **不上传云端**：用户数据不离开设备
- **加密存储**：推理结果加密保存
- **用户可控**：随时删除模型和数据

### 内容安全措施
- 敏感信息自动过滤
- 不当内容识别拦截
- 儿童内容保护
- 合规性检查

## 十、监控与优化

### 关键指标监控
- AI功能启用率
- 模型下载成功率
- 推理响应时间
- 缓存命中率
- 用户满意度

### 持续优化方向
- 模型大小压缩
- 推理速度提升
- 功能体验改进
- 用户反馈响应

## 十一、总结

### 核心设计理念
**AI是增值功能而非门槛，让用户自主选择，用价值吸引而非强制要求**

### 关键决策点
1. **模型选择**：Qwen3-0.6B，最佳平衡点
2. **用户选择**：可选下载，不强制
3. **基础保障**：无AI仍可完整使用
4. **隐私优先**：本地运行，数据不上传
5. **体验分级**：基础功能+AI增强

### 成功要素
- 清晰的价值主张
- 流畅的下载体验
- 可靠的基础模式
- 持续的优化迭代
- 用户信任建立

---

*设计版本：v1.0*  
*更新日期：2025-08-07*  
*状态：MVP方案*