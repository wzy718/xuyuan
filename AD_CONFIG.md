# 广告位配置指南

本文档说明如何在微信小程序中配置广告位，包括横幅广告和贴片广告。

## 前置条件

1. **小程序已发布**：广告功能需要小程序发布后才能使用（开发版和体验版无法显示广告）
2. **开通流量主**：需要在微信公众平台开通流量主功能
3. **小程序类目符合要求**：确保小程序类目符合微信广告要求

## ⚠️ 没有流量主资格怎么办？

如果你的小程序是第一个小程序，可能暂时没有资格开通流量主。不用担心，代码已经支持**无广告模式**：

### 临时解决方案

1. **保持默认配置**：`ENABLE_AD_UNLOCK` 设置为 `false`（已在配置文件中默认设置）
2. **只使用分享解锁**：用户可以通过"分享解锁"功能来解锁完整分析结果
3. **等有资格后再启用**：当你的小程序满足流量主开通条件后，再：
   - 开通流量主并创建广告位
   - 将 `ENABLE_AD_UNLOCK` 改为 `true`
   - 配置正确的广告位 ID
   - 重新构建并发布小程序

### 流量主开通条件（参考）

- 小程序已发布（非开发版/体验版）
- 小程序累计独立访客（UV）达到一定数量（具体以微信官方要求为准）
- 小程序类目符合广告要求
- 通过微信官方审核

**注意**：流量主开通条件可能会变化，请以微信公众平台最新要求为准。

## 配置步骤

### 步骤 1：开通流量主

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **流量主** → **开通流量主**
3. 填写相关信息并提交审核
4. 等待审核通过（通常 1-3 个工作日）

### 步骤 2：创建广告位

#### 2.1 创建横幅广告位（Banner）

1. 进入 **流量主** → **广告管理** → **广告位管理**
2. 点击 **新建广告位**
3. 选择广告类型：**Banner 广告**
4. 填写广告位信息：
   - **广告位名称**：例如 "首页横幅广告"
   - **广告位描述**：可选
5. 点击 **创建**，系统会生成广告位 ID（格式：`adunit-xxxxxxxxxxxxxxxx`）
6. 复制广告位 ID

#### 2.2 创建贴片广告位（Interstitial）

1. 同样在 **广告位管理** 页面
2. 点击 **新建广告位**
3. 选择广告类型：**插屏广告** 或 **激励视频广告**
   - **插屏广告**：适合在页面过渡时显示
   - **激励视频广告**：适合解锁功能时使用
4. 填写广告位信息并创建
5. 复制广告位 ID

### 步骤 3：配置到项目代码

#### 3.1 开发环境配置

编辑 `frontend/config/dev.js`：

```javascript
module.exports = {
  env: {
    NODE_ENV: '"development"'
  },
  defineConstants: {
    CLOUD_ENV_ID: '"cloud1-7gtd04o5108a99dd"',
    // 将下面的占位符替换为实际的广告位 ID
    BANNER_AD_UNIT_ID: '"adunit-你的横幅广告位ID"',
    INTERSTITIAL_AD_UNIT_ID: '"adunit-你的贴片广告位ID"',
    // 是否启用广告解锁功能（需要先开通流量主并配置广告位 ID）
    ENABLE_AD_UNLOCK: 'true' // 有流量主资格时设为 true，否则设为 false
  },
  mini: {},
  h5: {}
}
```

#### 3.2 生产环境配置

编辑 `frontend/config/prod.js`：

```javascript
module.exports = {
  env: {
    NODE_ENV: '"production"'
  },
  defineConstants: {
    CLOUD_ENV_ID: '"cloud1-7gtd04o5108a99dd"',
    // 将下面的占位符替换为实际的广告位 ID
    BANNER_AD_UNIT_ID: '"adunit-你的横幅广告位ID"',
    INTERSTITIAL_AD_UNIT_ID: '"adunit-你的贴片广告位ID"',
    // 是否启用广告解锁功能（需要先开通流量主并配置广告位 ID）
    ENABLE_AD_UNLOCK: 'true' // 有流量主资格时设为 true，否则设为 false
  },
  mini: {},
  h5: {}
}
```

**注意**：
- 广告位 ID 需要用双引号包裹，并且外层还要用单引号
- 开发环境和生产环境可以使用不同的广告位 ID（建议使用相同的，便于管理）

### 步骤 4：重新构建项目

配置完成后，需要重新构建项目：

```bash
cd frontend
npm run dev:weapp  # 开发环境
# 或
npm run build:weapp  # 生产环境
```

### 步骤 5：验证广告显示

1. 在微信开发者工具中预览小程序
2. 检查首页是否显示横幅广告
3. 触发愿望分析，检查过渡页是否显示贴片广告

**注意**：
- 开发版和体验版可能无法显示广告，需要发布到正式版才能看到
- 如果广告未显示，检查控制台是否有错误信息

## 广告位位置说明

### 横幅广告
- **位置**：首页顶部（愿望输入区域上方）
- **文件**：`frontend/src/pages/index/index.tsx`
- **配置常量**：`BANNER_AD_UNIT_ID`

### 贴片广告
- **位置**：愿望分析加载过渡页（莲花动画下方）
- **文件**：`frontend/src/components/AnalysisModal/index.tsx`
- **配置常量**：`INTERSTITIAL_AD_UNIT_ID`

## 常见问题

### Q1: 广告位 ID 格式是什么？

**A:** 广告位 ID 格式为：`adunit-` 后跟 16 位字符，例如：`adunit-1234567890abcdef`

### Q2: 开发版/体验版看不到广告？

**A:** 这是正常现象。微信广告只在正式版小程序中显示。开发版和体验版不会显示广告，但也不会报错。

### Q3: 广告加载失败怎么办？

**A:** 检查以下几点：
1. 广告位 ID 是否正确配置
2. 小程序是否已发布到正式版
3. 是否已开通流量主并通过审核
4. 查看控制台错误信息

### Q4: 如何测试广告功能？

**A:** 
1. 配置好广告位 ID 后，发布小程序到正式版
2. 使用正式版小程序测试
3. 或者使用微信开发者工具的"真机调试"功能

### Q5: 广告收益如何查看？

**A:** 登录微信公众平台 → **流量主** → **数据统计**，可以查看广告展示量、点击量、收益等数据。

## 注意事项

1. **广告位 ID 安全**：广告位 ID 可以暴露在前端代码中，这是微信小程序的标准做法
2. **广告审核**：广告内容由微信广告平台自动匹配，无需手动审核
3. **广告样式**：广告样式由微信平台控制，开发者无法自定义
4. **广告频率**：可以通过 `ad-intervals` 属性控制广告刷新间隔（单位：秒）

## 相关文档

- [微信小程序广告组件官方文档](https://developers.weixin.qq.com/miniprogram/dev/component/ad.html)
- [微信流量主开通指南](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/ad.html)
