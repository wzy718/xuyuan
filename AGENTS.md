# Repository Guidelines

## PRD 入口与变更流程
- PRD 主文档：`prd/prd.md`
- 配套文档：`prd/业务流程.md`、`prd/页面设计.md`、`prd/架构设计.md`
- 需求变更先更新 `prd/` 文档，再改代码，便于评审与追踪。

## 产品范围（以 PRD 为准）
- 启动：开屏广告（5 秒可跳过）→ 首次引导页（3 页）→ Tab 页面
- Tab：
  - Tab 1：愿望分析（输入 → 分析 → 解锁 → 展示完整结果 → 复制/记录）
  - Tab 2：我的愿望（列表/筛选/新增/详情/编辑/删除/标记成功）
  - Tab 3：个人中心（用户信息/统计/订单/设置等）
- 关键页面/弹窗：愿望详情页、新增愿望弹窗、还愿支付弹窗（1 元代还愿/回向）

## 项目结构与模块组织
- `prd/`：产品需求文档（以 `prd/prd.md` 为入口）。
- `frontend/`：微信小程序前端（Taro + React + TypeScript）。
- `frontend/cloudfunctions/`：微信云开发云函数（当前使用 `cloudfunctions/api` 作为统一入口，DeepSeek/支付/内容安全等仅允许在云函数侧执行）。
- `backend/`：旧版自建后端（Express + MySQL/Redis），仅作为可选方案，默认以云开发模式为准。
- `demo/`：Demo/原型资源（目前为空），建议按页面或功能拆分目录并保持可直接打开或可一键启动。

## 构建、测试与本地开发命令
### 前端（`frontend/`）
- `npm install`：安装依赖。
- `npm run dev:weapp`：本地开发（微信小程序）。
- `npm run build:weapp`：构建微信小程序产物。
- `npm run lint`：ESLint（提交前必跑）。

### 云函数（`frontend/cloudfunctions/`）
- 在微信开发者工具中右键云函数目录上传并部署（安装依赖）。

### 旧版后端（`backend/`，可选）
- `npm install`：安装依赖。
- `npm run dev`：本地开发（默认端口 `3000`）。
- `npm run start`：启动服务。
- `npm run init-db`：初始化 MySQL 表结构。
- `npm run lint`：ESLint（提交前必跑）。

## 编码风格与命名约定
- 前端统一使用 TypeScript（`.ts/.tsx`），函数式组件优先；缩进 2 空格。
- 后端当前为 Node.js（`.js`），保持现有风格与结构，不在无需求时做大规模 TS 迁移。
- 样式以现有 SCSS 为主，避免无必要的全局样式污染。
- 文档与代码注释必须使用中文。

## 关键非功能约束（来自 `prd/`，提交前自检）
- **API Key 安全**：DeepSeek API Key 必须通过云函数环境变量读取，禁止出现在前端代码、仓库文件或日志中。
- **内容安全**：后端/云函数必须调用微信内容安全能力（如 `msgSecCheck`）并做自定义规则过滤；同时要对模型输出再做一次安全审核。
- **限流与成本**：对“分析/优化”等 AI 接口做用户级限流（按 PRD 可配置每天 N 次）与必要的全局保护，避免被刷。
- **解锁风控**：广告/分享解锁无法强校验，按 `prd/架构设计.md` 做设备指纹/行为序列/频控/黑名单等风控，别把前端回调当真实凭证。
- **支付安全**：支付回调必须验签 + 去重 + 状态机推进（只前进不回退）+ 记录回调日志，保证幂等。

## UI/UX 约束（来自 `prd/页面设计.md`）
- 视觉风格：禅意中式；主色与组件样式按 `prd/页面设计.md` 执行（圆角卡片、金色边框等）。
- 体验要求：错误提示友好、加载状态明确、关键操作及时反馈；性能目标按 `prd/prd.md`（页面 <2s、分析 <5s）。

## 测试指南
当前暂无测试框架。若引入测试：
- 后端建议使用 `*.test.js`/`*.test.ts`（并提供 `npm test` 脚本）。
- 前端建议覆盖核心路径与流程：分析、解锁、TODO、新增愿望、支付弹窗等关键交互。

## 提交与 PR 规范
- 提交信息遵循 Conventional Commits：`feat: ...`、`fix: ...`、`docs: ...`、`refactor: ...`。
- PR 需包含：变更摘要、关联 issue（如有）、UI 变更截图/录屏、风险与回滚说明（如涉及线上行为）。

## 安全与配置提示
- 机密信息放入云函数环境变量/构建期常量并通过 `process.env`/编译期常量读取，禁止提交到仓库。
- 若新增部署步骤或第三方脚本依赖，请同步更新部署说明文档（如 `./DEPLOYMENT.md`）。

## Agent 协作约定
- 每次编辑文件前，用中文简要说明“为什么改、改什么”，便于审阅与对齐预期。
